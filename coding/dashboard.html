<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coding Dashboard</title>
<style>
:root {
  --ivory: #FAF8F5;
  --cream: #F5F2ED;
  --navy: #1a2744;
  --navy-light: #2d3d5c;
  --accent: #8B4513;
  --text: #2c2c2c;
  --text-light: #5a5a5a;
  --border: #e0ddd8;
  --success: #2d6a4f;
  --dim-F1: #4361ee;
  --dim-F2: #e07a5f;
  --dim-F3: #81b29a;
  --dim-regime_support: #9b2226;
  --dim-nationalism: #ca6702;
  --dim-satisfaction: #6a994e;
  --dim-none: #adb5bd;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--ivory); color: var(--text); line-height: 1.5;
}
.container { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }
h1 { font-size: 1.6rem; color: var(--navy); margin-bottom: 0.3rem; }
h2 { font-size: 1.15rem; color: var(--navy); margin: 1.8rem 0 0.6rem; border-bottom: 2px solid var(--border); padding-bottom: 0.3rem; }
h3 { font-size: 0.95rem; color: var(--navy-light); margin: 1rem 0 0.4rem; }
.subtitle { color: var(--text-light); font-size: 0.85rem; margin-bottom: 1.2rem; }
.card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem; }
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.6rem; margin-bottom: 1rem; }
.stat-box { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem; text-align: center; }
.stat-num { font-size: 1.8rem; font-weight: 700; color: var(--navy); }
.stat-lbl { font-size: 0.72rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; }
table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
th { background: var(--cream); font-weight: 600; text-align: left; padding: 0.5rem 0.6rem; border-bottom: 2px solid var(--border); }
td { padding: 0.45rem 0.6rem; border-bottom: 1px solid var(--cream); }
tr:hover td { background: #faf9f7; }
.mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.78rem; }
.dim-tag { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.72rem; font-weight: 600; color: #fff; }
.pct-bar { display: inline-block; height: 6px; border-radius: 3px; background: var(--success); vertical-align: middle; }
.warn { color: #c0392b; font-weight: 600; }
.ok { color: var(--success); font-weight: 600; }
.muted { color: var(--text-light); }
.login-box { max-width: 320px; margin: 15vh auto; text-align: center; }
.login-box input { width: 100%; padding: 0.7rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin: 0.8rem 0; }
.login-box button { padding: 0.7rem 2rem; background: var(--navy); color: #fff; border: none; border-radius: 6px; font-size: 0.95rem; cursor: pointer; }
.login-box button:hover { background: var(--navy-light); }
#dashboard { display: none; }
.loading { text-align: center; padding: 3rem; color: var(--text-light); }
.tab-bar { display: flex; gap: 0.3rem; margin-bottom: 1rem; flex-wrap: wrap; }
.tab-btn { padding: 0.4rem 0.8rem; border: 1px solid var(--border); border-radius: 5px; background: #fff; font-size: 0.8rem; cursor: pointer; }
.tab-btn.active { background: var(--navy); color: #fff; border-color: var(--navy); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }
.matrix-table td, .matrix-table th { text-align: center; min-width: 65px; font-size: 0.75rem; }
.matrix-table td.diag { background: #e8f5e9; font-weight: 700; }
.matrix-table td.offdiag { background: #fff3e0; }
.heatmap-cell { display: inline-block; width: 100%; padding: 0.2rem; border-radius: 2px; }
.refresh-btn { padding: 0.35rem 0.7rem; background: var(--cream); border: 1px solid var(--border); border-radius: 4px; font-size: 0.78rem; cursor: pointer; float: right; }
.refresh-btn:hover { background: var(--border); }
.note { font-size: 0.78rem; color: var(--text-light); font-style: italic; margin-top: 0.3rem; }
</style>
</head>
<body>

<!-- Password gate -->
<div id="login" class="login-box">
  <h1 style="font-size:1.3rem; color:var(--navy);">Coding Dashboard</h1>
  <p style="color:var(--text-light); font-size:0.85rem;">PI access only</p>
  <input type="password" id="pw-input" placeholder="Password" autofocus>
  <br>
  <button id="pw-btn">Enter</button>
  <p id="pw-error" style="color:#c0392b; font-size:0.82rem; margin-top:0.5rem; display:none;">Incorrect password</p>
</div>

<!-- Dashboard -->
<div id="dashboard" class="container">
  <div style="display:flex; justify-content:space-between; align-items:baseline; flex-wrap:wrap;">
    <div>
      <h1>RA Coding Dashboard</h1>
      <p class="subtitle">Last refreshed: <span id="last-refresh">-</span></p>
    </div>
    <button class="refresh-btn" onclick="fetchData()">Refresh</button>
  </div>

  <!-- Tabs -->
  <div class="tab-bar" id="tab-bar">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="detail">Survey Detail</button>
    <button class="tab-btn" data-tab="time">Time Analytics</button>
    <button class="tab-btn" data-tab="reliability">Inter-Rater Reliability</button>
  </div>

  <!-- Tab: Overview -->
  <div class="tab-panel active" id="tab-overview">
    <div class="stats-row" id="overview-stats"></div>
    <div class="card" id="overview-table-wrap">
      <table id="overview-table"><thead></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Tab: Survey Detail -->
  <div class="tab-panel" id="tab-detail">
    <div class="card" id="detail-content">
      <table id="detail-table"><thead></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Tab: Time Analytics -->
  <div class="tab-panel" id="tab-time">
    <h3>Per-Item Coding Time</h3>
    <div class="card" id="time-stats"></div>
    <h3>Per-RA Time Summary</h3>
    <div class="card" id="time-ra"></div>
    <h3>Activity by Hour</h3>
    <div class="card" id="time-heatmap"></div>
  </div>

  <!-- Tab: Inter-Rater Reliability -->
  <div class="tab-panel" id="tab-reliability">
    <div id="reliability-content"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════
// Dashboard — fetches from GAS, computes all metrics client-side
// ═══════════════════════════════════════════════════════════════════

const GAS_URL = 'https://script.google.com/macros/s/AKfycbwtABPWzEoT2qzs3YOxyZp_J9EoIYr6ageICfKFc8PoagDl7oDaLRDLHHkkBcR1CcNMOQ/exec';
const PASSWORD = 'cleavages2026';

const DIM_COLORS = {
  F1: '#4361ee', F2: '#e07a5f', F3: '#81b29a',
  regime_support: '#9b2226', nationalism: '#ca6702',
  satisfaction: '#6a994e', none: '#adb5bd'
};
const DIM_LABELS = {
  F1: 'Political', F2: 'Economic', F3: 'Social',
  regime_support: 'Regime Supp.', nationalism: 'Nationalism',
  satisfaction: 'Satisfaction', none: 'Not Relevant'
};
const ALL_DIMS = ['F1', 'F2', 'F3', 'regime_support', 'nationalism', 'satisfaction', 'none'];

let allEvents = [];

// ── Password Gate ──────────────────────────
document.getElementById('pw-btn').addEventListener('click', tryLogin);
document.getElementById('pw-input').addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin(); });

function tryLogin() {
  const pw = document.getElementById('pw-input').value;
  if (pw === PASSWORD) {
    document.getElementById('login').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    fetchData();
  } else {
    document.getElementById('pw-error').style.display = 'block';
  }
}

// ── Tab Switching ──────────────────────────
document.getElementById('tab-bar').addEventListener('click', e => {
  const btn = e.target.closest('.tab-btn');
  if (!btn) return;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
});

// ── Fetch Data from GAS (JSONP to avoid CORS) ──
function fetchData() {
  if (!GAS_URL) {
    document.getElementById('overview-stats').innerHTML =
      '<div class="card" style="grid-column:1/-1;text-align:center;color:var(--text-light);">GAS_URL not configured.</div>';
    return;
  }
  document.getElementById('overview-stats').innerHTML = '<div class="loading">Loading...</div>';

  const cbName = '_gasCb' + Date.now();
  const script = document.createElement('script');

  // Timeout fallback
  const timer = setTimeout(() => {
    cleanup();
    document.getElementById('overview-stats').innerHTML =
      '<div class="card" style="grid-column:1/-1;color:#c0392b;">Request timed out. Check GAS deployment.</div>';
  }, 15000);

  function cleanup() {
    clearTimeout(timer);
    delete window[cbName];
    if (script.parentNode) script.parentNode.removeChild(script);
  }

  window[cbName] = function(data) {
    cleanup();
    if (data.error) {
      document.getElementById('overview-stats').innerHTML =
        '<div class="card" style="grid-column:1/-1;color:#c0392b;">Error: ' + data.error + '</div>';
      return;
    }
    allEvents = data.events || [];
    document.getElementById('last-refresh').textContent = new Date().toLocaleString();
    renderAll();
  };

  script.src = GAS_URL + '?action=fetch_data&pw=' + encodeURIComponent(PASSWORD) + '&cb=' + cbName;
  script.onerror = function() {
    cleanup();
    document.getElementById('overview-stats').innerHTML =
      '<div class="card" style="grid-column:1/-1;color:#c0392b;">Failed to load data. Check GAS URL and deployment.</div>';
  };
  document.head.appendChild(script);
}

// ── Render All Tabs ────────────────────────
function renderAll() {
  const confirms = allEvents.filter(e => e.event_type === 'confirm');
  renderOverview(confirms);
  renderDetail(confirms);
  renderTime(confirms);
  renderReliability(confirms);
}

// ── Tab 1: Overview ────────────────────────
function renderOverview(confirms) {
  const ras = [...new Set(confirms.map(e => e.ra))].filter(Boolean);
  const surveys = [...new Set(confirms.map(e => e.survey))].filter(Boolean);
  const totalItems = confirms.length;

  // Sessions
  const sessions = allEvents.filter(e => e.event_type === 'session_start');
  const exports = allEvents.filter(e => e.event_type === 'export');

  document.getElementById('overview-stats').innerHTML = `
    <div class="stat-box"><div class="stat-num">${ras.length}</div><div class="stat-lbl">RAs</div></div>
    <div class="stat-box"><div class="stat-num">${surveys.length}</div><div class="stat-lbl">Surveys</div></div>
    <div class="stat-box"><div class="stat-num">${totalItems}</div><div class="stat-lbl">Items Coded</div></div>
    <div class="stat-box"><div class="stat-num">${sessions.length}</div><div class="stat-lbl">Sessions</div></div>
    <div class="stat-box"><div class="stat-num">${exports.length}</div><div class="stat-lbl">Exports</div></div>
  `;

  // Per-RA table
  const tbody = document.querySelector('#overview-table tbody');
  const thead = document.querySelector('#overview-table thead');
  thead.innerHTML = '<tr><th>RA</th><th>Surveys</th><th>Items Coded</th><th>Last Active</th><th>By Dimension</th></tr>';
  tbody.innerHTML = '';

  ras.sort().forEach(ra => {
    const raConf = confirms.filter(e => e.ra === ra);
    const raSurveys = [...new Set(raConf.map(e => e.survey))];
    const lastTs = raConf.reduce((max, e) => {
      const t = e.server_ts || '';
      return t > max ? t : max;
    }, '');
    const dimCounts = {};
    ALL_DIMS.forEach(d => dimCounts[d] = 0);
    raConf.forEach(e => { const d = e.dimension || 'none'; dimCounts[d] = (dimCounts[d] || 0) + 1; });
    const dimHtml = ALL_DIMS.map(d =>
      dimCounts[d] > 0 ? `<span class="dim-tag" style="background:${DIM_COLORS[d]}">${DIM_LABELS[d]} ${dimCounts[d]}</span> ` : ''
    ).join('');

    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${esc(ra)}</strong></td>
      <td>${raSurveys.length} (${esc(raSurveys.join(', '))})</td>
      <td>${raConf.length}</td>
      <td class="mono">${lastTs ? new Date(lastTs).toLocaleString() : '-'}</td>
      <td>${dimHtml}</td>`;
    tbody.appendChild(tr);
  });
}

// ── Tab 2: Survey Detail ───────────────────
function renderDetail(confirms) {
  const thead = document.querySelector('#detail-table thead');
  const tbody = document.querySelector('#detail-table tbody');
  thead.innerHTML = '<tr><th>RA</th><th>Survey</th><th>Items Coded</th><th>First Activity</th><th>Last Activity</th><th>Completion %</th></tr>';
  tbody.innerHTML = '';

  const groups = {};
  confirms.forEach(e => {
    const k = `${e.ra}__${e.survey}`;
    if (!groups[k]) groups[k] = { ra: e.ra, survey: e.survey, items: new Set(), first: e.server_ts, last: e.server_ts, totalVars: 0 };
    groups[k].items.add(e.var_id);
    if (e.server_ts < groups[k].first) groups[k].first = e.server_ts;
    if (e.server_ts > groups[k].last) groups[k].last = e.server_ts;
    if (e.total_vars && parseInt(e.total_vars) > groups[k].totalVars) groups[k].totalVars = parseInt(e.total_vars);
  });

  Object.values(groups).sort((a, b) => a.ra.localeCompare(b.ra) || a.survey.localeCompare(b.survey)).forEach(g => {
    const count = g.items.size;
    const total = g.totalVars || '?';
    const pct = g.totalVars ? Math.round(count / g.totalVars * 100) : '?';
    const pctBar = g.totalVars ? `<span class="pct-bar" style="width:${Math.min(pct, 100)}px"></span> ${pct}%` : '?';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${esc(g.ra)}</td><td>${esc(g.survey)}</td><td>${count}${g.totalVars ? ' / ' + total : ''}</td>
      <td class="mono">${new Date(g.first).toLocaleString()}</td>
      <td class="mono">${new Date(g.last).toLocaleString()}</td>
      <td>${pctBar}</td>`;
    tbody.appendChild(tr);
  });
}

// ── Tab 3: Time Analytics ──────────────────
function renderTime(confirms) {
  const times = confirms.map(e => parseInt(e.view_ms) || 0).filter(t => t > 0 && t < 600000);
  times.sort((a, b) => a - b);

  const median = times.length ? times[Math.floor(times.length / 2)] : 0;
  const mean = times.length ? Math.round(times.reduce((s, t) => s + t, 0) / times.length) : 0;
  const p10 = times.length ? times[Math.floor(times.length * 0.1)] : 0;
  const p90 = times.length ? times[Math.floor(times.length * 0.9)] : 0;

  document.getElementById('time-stats').innerHTML = `
    <div class="stats-row">
      <div class="stat-box"><div class="stat-num">${fmt_ms(median)}</div><div class="stat-lbl">Median</div></div>
      <div class="stat-box"><div class="stat-num">${fmt_ms(mean)}</div><div class="stat-lbl">Mean</div></div>
      <div class="stat-box"><div class="stat-num">${fmt_ms(p10)}</div><div class="stat-lbl">P10 (fast)</div></div>
      <div class="stat-box"><div class="stat-num">${fmt_ms(p90)}</div><div class="stat-lbl">P90 (slow)</div></div>
      <div class="stat-box"><div class="stat-num">${times.length}</div><div class="stat-lbl">Items with Time</div></div>
    </div>`;

  // Per-RA time
  const raGroups = {};
  confirms.forEach(e => {
    const t = parseInt(e.view_ms) || 0;
    if (t <= 0 || t >= 600000) return;
    if (!raGroups[e.ra]) raGroups[e.ra] = [];
    raGroups[e.ra].push(t);
  });
  let raHtml = '<table><tr><th>RA</th><th>Items</th><th>Median</th><th>Mean</th><th>Total Time</th></tr>';
  Object.keys(raGroups).sort().forEach(ra => {
    const ts = raGroups[ra].sort((a, b) => a - b);
    const m = ts[Math.floor(ts.length / 2)];
    const avg = Math.round(ts.reduce((s, t) => s + t, 0) / ts.length);
    const total = ts.reduce((s, t) => s + t, 0);
    raHtml += `<tr><td>${esc(ra)}</td><td>${ts.length}</td><td>${fmt_ms(m)}</td><td>${fmt_ms(avg)}</td><td>${fmt_duration(total)}</td></tr>`;
  });
  raHtml += '</table>';
  document.getElementById('time-ra').innerHTML = raHtml;

  // Hour heatmap
  const hourCounts = new Array(24).fill(0);
  confirms.forEach(e => {
    if (e.server_ts) {
      const h = new Date(e.server_ts).getHours();
      if (!isNaN(h)) hourCounts[h]++;
    }
  });
  const maxHour = Math.max(...hourCounts, 1);
  let heatHtml = '<div style="display:flex; gap:2px; align-items:flex-end; height:80px; padding:0.5rem 0;">';
  for (let h = 0; h < 24; h++) {
    const pct = Math.round(hourCounts[h] / maxHour * 100);
    const bg = hourCounts[h] > 0 ? 'var(--navy)' : 'var(--cream)';
    heatHtml += `<div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:2px;">
      <div style="width:100%; height:${Math.max(pct, 2)}%; background:${bg}; border-radius:2px 2px 0 0; min-height:2px;"></div>
      <div style="font-size:0.6rem; color:var(--text-light);">${h}</div>
    </div>`;
  }
  heatHtml += '</div><p class="note">Hour of day (server time). Height = relative activity.</p>';
  document.getElementById('time-heatmap').innerHTML = heatHtml;
}

// ── Tab 4: Inter-Rater Reliability ─────────
function renderReliability(confirms) {
  const container = document.getElementById('reliability-content');

  // Build coding map: { var_id: { ra: dimension } }
  const codingMap = {};
  confirms.forEach(e => {
    const vid = `${e.survey}__${e.var_id}`;
    if (!codingMap[vid]) codingMap[vid] = {};
    codingMap[vid][e.ra] = e.dimension || 'none';
  });

  // Find items coded by 2+ RAs
  const sharedItems = {};
  for (const vid in codingMap) {
    const ras = Object.keys(codingMap[vid]);
    if (ras.length >= 2) sharedItems[vid] = codingMap[vid];
  }
  const sharedCount = Object.keys(sharedItems).length;
  const allRAs = [...new Set(confirms.map(e => e.ra))].filter(Boolean).sort();

  if (sharedCount === 0) {
    container.innerHTML = `<div class="card"><p class="muted">No overlapping items found. Inter-rater reliability requires at least 2 RAs coding the same variables.</p>
      <p class="muted" style="margin-top:0.5rem;">RAs detected: ${allRAs.join(', ') || 'none'}</p></div>`;
    return;
  }

  let html = '';
  html += `<div class="card"><strong>${sharedCount}</strong> items coded by 2+ RAs across <strong>${allRAs.length}</strong> coders.`;
  if (sharedCount < 50) html += ` <span class="warn">Warning: <50 shared items — reliability estimates will be unstable.</span>`;
  html += '</div>';

  // ── Per-Dimension Metrics ──────────────────
  html += '<h2>Per-Dimension Reliability</h2>';
  html += '<p class="note">For each dimension: how consistently do RAs agree on whether a variable belongs to this category?</p>';

  // For each RA pair, compute per-dimension metrics
  const raPairs = [];
  for (let i = 0; i < allRAs.length; i++) {
    for (let j = i + 1; j < allRAs.length; j++) {
      raPairs.push([allRAs[i], allRAs[j]]);
    }
  }

  // Collect all pairwise ratings for shared items
  raPairs.forEach(([raA, raB]) => {
    const pairItems = [];
    for (const vid in sharedItems) {
      if (sharedItems[vid][raA] !== undefined && sharedItems[vid][raB] !== undefined) {
        pairItems.push({ vid, a: sharedItems[vid][raA], b: sharedItems[vid][raB] });
      }
    }
    if (pairItems.length === 0) return;

    html += `<h3>${esc(raA)} vs ${esc(raB)} (${pairItems.length} shared items)</h3>`;

    // Per-dimension binary metrics
    html += '<table><tr><th>Dimension</th><th>TP</th><th>FP</th><th>FN</th><th>TN</th><th>Precision</th><th>Recall</th><th>F1</th><th>Cohen\'s Kappa</th><th>Agree %</th></tr>';

    ALL_DIMS.forEach(dim => {
      // Binary: "this dim" vs "not this dim" for each coder
      let tp = 0, fp = 0, fn = 0, tn = 0;
      pairItems.forEach(({ a, b }) => {
        const aYes = a === dim, bYes = b === dim;
        if (aYes && bYes) tp++;
        else if (!aYes && bYes) fp++;  // B says yes, A says no (from A's perspective as "truth")
        else if (aYes && !bYes) fn++;
        else tn++;
      });
      const n = pairItems.length;
      const precision = (tp + fp) > 0 ? tp / (tp + fp) : NaN;
      const recall = (tp + fn) > 0 ? tp / (tp + fn) : NaN;
      const f1 = (precision + recall) > 0 ? 2 * precision * recall / (precision + recall) : NaN;
      const po = (tp + tn) / n;
      const pA = ((tp + fn) / n) * ((tp + fp) / n) + ((fp + tn) / n) * ((fn + tn) / n);
      const kappa = pA < 1 ? (po - pA) / (1 - pA) : 1;
      const agree = Math.round(po * 100);
      const color = DIM_COLORS[dim] || '#666';

      html += `<tr>
        <td><span class="dim-tag" style="background:${color}">${DIM_LABELS[dim] || dim}</span></td>
        <td>${tp}</td><td>${fp}</td><td>${fn}</td><td>${tn}</td>
        <td>${fmtPct(precision)}</td>
        <td>${fmtPct(recall)}</td>
        <td class="${f1 >= 0.8 ? 'ok' : f1 < 0.667 ? 'warn' : ''}">${fmtPct(f1)}</td>
        <td class="${kappa >= 0.8 ? 'ok' : kappa < 0.667 ? 'warn' : ''}">${fmtDec(kappa)}</td>
        <td>${agree}%</td>
      </tr>`;
    });

    // Overall row
    const totalAgree = pairItems.filter(({ a, b }) => a === b).length;
    const overallPo = totalAgree / pairItems.length;
    const overallKappa = computeCohenKappa(pairItems.map(p => p.a), pairItems.map(p => p.b), ALL_DIMS);
    html += `<tr style="border-top:2px solid var(--border);">
      <td><strong>Overall</strong></td>
      <td colspan="4"></td>
      <td colspan="2"></td>
      <td></td>
      <td class="${overallKappa >= 0.8 ? 'ok' : overallKappa < 0.667 ? 'warn' : ''}"><strong>${fmtDec(overallKappa)}</strong></td>
      <td><strong>${Math.round(overallPo * 100)}%</strong></td>
    </tr>`;
    html += '</table>';

    // Confusion matrix
    html += '<h3 style="margin-top:0.8rem;">Confusion Matrix</h3>';
    html += '<table class="matrix-table"><tr><th></th>';
    ALL_DIMS.forEach(d => { html += `<th style="color:${DIM_COLORS[d]}">${DIM_LABELS[d]}</th>`; });
    html += '</tr>';
    ALL_DIMS.forEach(dA => {
      html += `<tr><th style="color:${DIM_COLORS[dA]}">${DIM_LABELS[dA]}</th>`;
      ALL_DIMS.forEach(dB => {
        const count = pairItems.filter(({ a, b }) => a === dA && b === dB).length;
        const cls = dA === dB ? 'diag' : (count > 0 ? 'offdiag' : '');
        html += `<td class="${cls}">${count || ''}</td>`;
      });
      html += '</tr>';
    });
    html += '</table>';
    html += `<p class="note">Rows = ${esc(raA)}'s coding, Columns = ${esc(raB)}'s coding. Diagonal = agreement.</p>`;
  });

  // ── Krippendorff's Alpha (per dimension) ──
  if (allRAs.length >= 2) {
    html += '<h2>Krippendorff\'s Alpha (Per Dimension)</h2>';
    html += '<p class="note">Handles >2 coders and missing data. Computed as binary (this dim vs. not) for each dimension.</p>';
    html += '<table><tr><th>Dimension</th><th>Alpha</th><th>N (coded by 2+)</th><th>Interpretation</th></tr>';

    ALL_DIMS.forEach(dim => {
      // Build reliability data matrix: items x coders (binary: 1 = this dim, 0 = not)
      const items = Object.keys(sharedItems);
      const alpha = computeKrippendorffAlpha(items, sharedItems, allRAs, dim);
      const n = items.filter(vid => {
        const coded = Object.values(sharedItems[vid]);
        return coded.length >= 2;
      }).length;
      const interp = alpha >= 0.8 ? '<span class="ok">Good</span>'
        : alpha >= 0.667 ? 'Acceptable'
        : '<span class="warn">Unreliable</span>';
      const color = DIM_COLORS[dim] || '#666';
      html += `<tr>
        <td><span class="dim-tag" style="background:${color}">${DIM_LABELS[dim]}</span></td>
        <td class="${alpha >= 0.8 ? 'ok' : alpha < 0.667 ? 'warn' : ''}">${fmtDec(alpha)}</td>
        <td>${n}</td>
        <td>${interp}</td>
      </tr>`;
    });

    // Overall alpha (nominal, all categories)
    const overallAlpha = computeKrippendorffAlphaNominal(Object.keys(sharedItems), sharedItems, allRAs, ALL_DIMS);
    html += `<tr style="border-top:2px solid var(--border);">
      <td><strong>Overall (nominal)</strong></td>
      <td class="${overallAlpha >= 0.8 ? 'ok' : overallAlpha < 0.667 ? 'warn' : ''}"><strong>${fmtDec(overallAlpha)}</strong></td>
      <td>${Object.keys(sharedItems).length}</td>
      <td>${overallAlpha >= 0.8 ? '<span class="ok">Good</span>' : overallAlpha >= 0.667 ? 'Acceptable' : '<span class="warn">Unreliable</span>'}</td>
    </tr>`;
    html += '</table>';
  }

  // ── Most Disagreed Items ─────────────────
  html += '<h2>Most Disagreed Items</h2>';
  html += '<p class="note">Variables where coders assigned different dimensions. Useful for identifying ambiguous items.</p>';

  const disagreed = [];
  for (const vid in sharedItems) {
    const codings = sharedItems[vid];
    const dims = Object.values(codings);
    const uniqueDims = [...new Set(dims)];
    if (uniqueDims.length > 1) {
      disagreed.push({ vid, codings, uniqueDims });
    }
  }
  disagreed.sort((a, b) => b.uniqueDims.length - a.uniqueDims.length);

  if (disagreed.length === 0) {
    html += '<div class="card"><p class="ok">Perfect agreement on all shared items!</p></div>';
  } else {
    html += `<div class="card"><p>${disagreed.length} items with disagreement out of ${sharedCount} shared (${Math.round(disagreed.length/sharedCount*100)}% disagreement rate)</p></div>`;
    html += '<table><tr><th>Variable</th>';
    allRAs.forEach(ra => { html += `<th>${esc(ra)}</th>`; });
    html += '</tr>';
    disagreed.slice(0, 100).forEach(({ vid, codings }) => {
      html += `<tr><td class="mono">${esc(vid)}</td>`;
      allRAs.forEach(ra => {
        const d = codings[ra];
        if (d) {
          html += `<td><span class="dim-tag" style="background:${DIM_COLORS[d] || '#666'}">${DIM_LABELS[d] || d}</span></td>`;
        } else {
          html += '<td class="muted">-</td>';
        }
      });
      html += '</tr>';
    });
    html += '</table>';
    if (disagreed.length > 100) html += `<p class="note">Showing first 100 of ${disagreed.length} disagreed items.</p>`;
  }

  container.innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════════
// Statistical Functions
// ═══════════════════════════════════════════════════════════════════

// Cohen's Kappa (multi-category nominal)
function computeCohenKappa(ratingsA, ratingsB, categories) {
  const n = ratingsA.length;
  if (n === 0) return 0;

  // Observed agreement
  let agree = 0;
  for (let i = 0; i < n; i++) {
    if (ratingsA[i] === ratingsB[i]) agree++;
  }
  const po = agree / n;

  // Expected agreement
  let pe = 0;
  categories.forEach(cat => {
    const pA = ratingsA.filter(r => r === cat).length / n;
    const pB = ratingsB.filter(r => r === cat).length / n;
    pe += pA * pB;
  });

  return pe < 1 ? (po - pe) / (1 - pe) : 1;
}

// Krippendorff's Alpha (binary: one dim vs rest)
function computeKrippendorffAlpha(items, sharedItems, allRAs, targetDim) {
  // Build coincidence matrix for binary coding
  // Value 1 = targetDim, Value 0 = not targetDim
  let n_agree = 0, n_disagree = 0;
  let n_1 = 0, n_0 = 0;
  let totalPairs = 0;

  items.forEach(vid => {
    const codings = sharedItems[vid];
    const rasCoded = allRAs.filter(ra => codings[ra] !== undefined);
    if (rasCoded.length < 2) return;

    const vals = rasCoded.map(ra => codings[ra] === targetDim ? 1 : 0);
    const m = vals.length;

    // Count pairs within this unit
    for (let i = 0; i < m; i++) {
      for (let j = i + 1; j < m; j++) {
        totalPairs++;
        if (vals[i] === vals[j]) n_agree++;
        else n_disagree++;
        n_1 += (vals[i] === 1 ? 1 : 0) + (vals[j] === 1 ? 1 : 0);
        n_0 += (vals[i] === 0 ? 1 : 0) + (vals[j] === 0 ? 1 : 0);
      }
    }
  });

  if (totalPairs === 0) return 0;

  // Observed disagreement
  const Do = n_disagree / totalPairs;

  // Expected disagreement (binary)
  const totalVals = n_1 + n_0;
  const p1 = n_1 / totalVals;
  const p0 = n_0 / totalVals;
  const De = 2 * p1 * p0;  // for binary

  if (De === 0) return 1;
  return 1 - Do / De;
}

// Krippendorff's Alpha (nominal, all categories)
function computeKrippendorffAlphaNominal(items, sharedItems, allRAs, categories) {
  // Coincidence matrix approach
  const coincidence = {};
  categories.forEach(c => {
    coincidence[c] = {};
    categories.forEach(d => coincidence[c][d] = 0);
  });

  let totalPairedValues = 0;

  items.forEach(vid => {
    const codings = sharedItems[vid];
    const rasCoded = allRAs.filter(ra => codings[ra] !== undefined);
    if (rasCoded.length < 2) return;

    const vals = rasCoded.map(ra => codings[ra]);
    const m = vals.length;

    // For each pair of coders within this unit
    for (let i = 0; i < m; i++) {
      for (let j = i + 1; j < m; j++) {
        const c = vals[i], d = vals[j];
        if (coincidence[c] && coincidence[c][d] !== undefined) {
          coincidence[c][d]++;
          coincidence[d][c]++;
          totalPairedValues += 2;
        }
      }
    }
  });

  if (totalPairedValues === 0) return 0;

  // Marginals
  const nc = {};
  categories.forEach(c => {
    nc[c] = 0;
    categories.forEach(d => nc[c] += coincidence[c][d]);
  });

  // Observed disagreement
  let Do = 0;
  for (let i = 0; i < categories.length; i++) {
    for (let j = i + 1; j < categories.length; j++) {
      const c = categories[i], d = categories[j];
      Do += coincidence[c][d];
    }
  }
  Do = Do / (totalPairedValues / 2);

  // Expected disagreement (nominal metric)
  let De = 0;
  const n = totalPairedValues;
  for (let i = 0; i < categories.length; i++) {
    for (let j = i + 1; j < categories.length; j++) {
      De += nc[categories[i]] * nc[categories[j]];
    }
  }
  De = De / (n * (n - 1) / 2);

  if (De === 0) return 1;
  return 1 - Do / De;
}

// ═══════════════════════════════════════════════════════════════════
// Formatting Helpers
// ═══════════════════════════════════════════════════════════════════

function fmt_ms(ms) {
  if (!ms || ms <= 0) return '-';
  if (ms < 1000) return ms + 'ms';
  return (ms / 1000).toFixed(1) + 's';
}

function fmt_duration(ms) {
  if (!ms) return '-';
  const mins = Math.floor(ms / 60000);
  const hrs = Math.floor(mins / 60);
  if (hrs > 0) return hrs + 'h ' + (mins % 60) + 'm';
  return mins + 'm';
}

function fmtPct(v) {
  if (isNaN(v)) return '<span class="muted">-</span>';
  return Math.round(v * 100) + '%';
}

function fmtDec(v) {
  if (isNaN(v)) return '<span class="muted">-</span>';
  return v.toFixed(3);
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}
</script>
</body>
</html>
