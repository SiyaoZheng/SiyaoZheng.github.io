<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coding Progress</title>
<style>
:root {
  --ivory: #FAF8F5; --cream: #F5F2ED; --navy: #1a2744; --navy-light: #2d3d5c;
  --accent: #8B4513; --text: #2c2c2c; --text-light: #5a5a5a; --border: #e0ddd8;
  --success: #2d6a4f; --success-bg: #d8f3dc; --warn: #c0392b; --warn-bg: #fdecea;
  --caution: #e67e22; --caution-bg: #fef5e7;
  --dim-F1: #4361ee; --dim-F2: #e07a5f; --dim-F3: #81b29a;
  --dim-regime_support: #9b2226; --dim-nationalism: #ca6702;
  --dim-satisfaction: #6a994e; --dim-none: #adb5bd;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--ivory); color: var(--text); line-height: 1.5; }
.container { max-width: 1000px; margin: 0 auto; padding: 1.5rem; }
h1 { font-size: 1.5rem; color: var(--navy); }
.subtitle { color: var(--text-light); font-size: 0.82rem; }

/* ── Alert banner ── */
.alert-bar { padding: 0.7rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; display: none; }
.alert-bar.warn { display: block; background: var(--warn-bg); border: 1px solid var(--warn); color: var(--warn); }
.alert-bar.caution { display: block; background: var(--caution-bg); border: 1px solid var(--caution); color: #7a4500; }

/* ── RA Section ── */
.ra-section { background: #fff; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 1.2rem; overflow: hidden; }
.ra-header { display: flex; justify-content: space-between; align-items: center; padding: 0.9rem 1.2rem; cursor: pointer; gap: 1rem; flex-wrap: wrap; }
.ra-header:hover { background: #faf9f7; }
.ra-name { font-size: 1.1rem; font-weight: 700; color: var(--navy); }
.ra-badges { display: flex; gap: 0.4rem; flex-wrap: wrap; }
.badge { display: inline-block; padding: 0.15rem 0.55rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
.badge-green { background: var(--success-bg); color: var(--success); }
.badge-yellow { background: var(--caution-bg); color: #7a4500; }
.badge-red { background: var(--warn-bg); color: var(--warn); }
.badge-grey { background: var(--cream); color: var(--text-light); }
.ra-summary { display: flex; gap: 1.5rem; font-size: 0.8rem; color: var(--text-light); flex-wrap: wrap; }
.ra-summary strong { color: var(--text); }
.ra-detail { display: none; padding: 0 1.2rem 1rem; border-top: 1px solid var(--cream); }
.ra-detail.open { display: block; }

/* ── Metrics row ── */
.metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 0.5rem; margin: 0.8rem 0; }
.metric { text-align: center; padding: 0.6rem; background: var(--cream); border-radius: 6px; }
.metric-num { font-size: 1.3rem; font-weight: 700; color: var(--navy); }
.metric-lbl { font-size: 0.68rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.04em; }

/* ── Tables ── */
table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin: 0.5rem 0; }
th { background: var(--cream); font-weight: 600; text-align: left; padding: 0.4rem 0.5rem; border-bottom: 2px solid var(--border); }
td { padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--cream); }
tr:hover td { background: #faf9f7; }
.mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.75rem; }

/* ── Tags ── */
.dim-tag { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600; color: #fff; }
.pct-bar { display: inline-block; height: 6px; border-radius: 3px; background: var(--success); vertical-align: middle; }
.warn-text { color: var(--warn); font-weight: 600; }
.ok-text { color: var(--success); font-weight: 600; }
.muted { color: var(--text-light); }
.note { font-size: 0.75rem; color: var(--text-light); font-style: italic; margin-top: 0.3rem; }
.section-title { font-size: 0.88rem; font-weight: 600; color: var(--navy-light); margin: 1rem 0 0.4rem; padding-bottom: 0.2rem; border-bottom: 1px solid var(--cream); }

/* ── Confusion matrix ── */
.matrix-table td, .matrix-table th { text-align: center; min-width: 55px; font-size: 0.72rem; }
.matrix-table td.diag { background: #e8f5e9; font-weight: 700; }
.matrix-table td.offdiag { background: #fff3e0; }

/* ── Login ── */
.login-box { max-width: 320px; margin: 15vh auto; text-align: center; }
.login-box input { width: 100%; padding: 0.7rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin: 0.8rem 0; }
.login-box button { padding: 0.7rem 2rem; background: var(--navy); color: #fff; border: none; border-radius: 6px; cursor: pointer; }
.login-box button:hover { background: var(--navy-light); }
#dashboard { display: none; }
.loading { text-align: center; padding: 3rem; color: var(--text-light); }

/* ── Top bar ── */
.top-bar { display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; margin-bottom: 1rem; gap: 0.5rem; }
.top-actions { display: flex; gap: 0.4rem; }
.btn { padding: 0.3rem 0.7rem; border: 1px solid var(--border); border-radius: 5px; font-size: 0.78rem; cursor: pointer; background: #fff; }
.btn:hover { background: var(--cream); }
.btn-danger { color: var(--warn); border-color: var(--warn); }
.btn-danger:hover { background: var(--warn-bg); }

/* ── Hour chart ── */
.hour-chart { display: flex; gap: 1px; align-items: flex-end; height: 40px; }
.hour-bar { flex: 1; background: var(--navy); border-radius: 1px 1px 0 0; min-height: 0; }
.hour-labels { display: flex; gap: 1px; font-size: 0.55rem; color: var(--text-light); }
.hour-labels span { flex: 1; text-align: center; }
</style>
</head>
<body>

<div id="login" class="login-box">
  <h1 style="font-size:1.3rem; color:var(--navy);">Coding Progress</h1>
  <p style="color:var(--text-light); font-size:0.85rem;">Team overview</p>
  <input type="password" id="pw-input" placeholder="Password" autofocus>
  <br>
  <button id="pw-btn">Enter</button>
  <p id="pw-error" style="color:#c0392b; font-size:0.82rem; margin-top:0.5rem; display:none;">Incorrect password</p>
</div>

<div id="dashboard" class="container">
  <div class="top-bar">
    <div>
      <h1>Coding Progress</h1>
      <p class="subtitle">Last refreshed: <span id="last-refresh">-</span> &middot; <span id="event-count">0</span> events</p>
    </div>
    <div class="top-actions">
      <button class="btn" onclick="fetchData()">Refresh</button>
      <button class="btn" onclick="downloadCSV()">Export CSV</button>
    </div>
  </div>
  <div id="alerts"></div>
  <div id="ra-list"></div>
  <div id="no-data" class="loading" style="display:none;">No events recorded yet. Beacons will appear here once RAs start coding.</div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyaNy_KfdXPbu827r5g-EZRIVdK8DvVtjgIRFv5jySRsTS-_HP1fH2Ffd4tEgR9y82LQw/exec';
const TOKEN = 'cleavages2026';
const urlToken = new URLSearchParams(window.location.search).get('token');

const DIM_COLORS = { F1:'#4361ee', F2:'#e07a5f', F3:'#81b29a', regime_support:'#9b2226', nationalism:'#ca6702', satisfaction:'#6a994e', none:'#adb5bd' };
const DIM_LABELS = { F1:'Political', F2:'Economic', F3:'Social', regime_support:'Regime Supp.', nationalism:'Nationalism', satisfaction:'Satisfaction', none:'Not Relevant' };
const ALL_DIMS = ['F1','F2','F3','regime_support','nationalism','satisfaction','none'];

let allEvents = [];

// ── Auth ──
document.getElementById('pw-btn').addEventListener('click', tryLogin);
document.getElementById('pw-input').addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin(); });
if (urlToken === TOKEN) { document.getElementById('login').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; fetchData(); }
function tryLogin() {
  if (document.getElementById('pw-input').value === TOKEN) {
    document.getElementById('login').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    fetchData();
  } else { document.getElementById('pw-error').style.display = 'block'; }
}

// ── Fetch ──
function fetchData() {
  document.getElementById('ra-list').innerHTML = '<div class="loading">Loading...</div>';
  const cbName = '_cb' + Date.now();
  const script = document.createElement('script');
  const timer = setTimeout(() => { cleanup(); document.getElementById('ra-list').innerHTML = '<div class="loading" style="color:var(--warn);">Timed out.</div>'; }, 15000);
  function cleanup() { clearTimeout(timer); delete window[cbName]; if (script.parentNode) script.parentNode.removeChild(script); }
  window[cbName] = function(data) {
    cleanup();
    if (data.error) { document.getElementById('ra-list').innerHTML = '<div class="loading" style="color:var(--warn);">Error: ' + data.error + '</div>'; return; }
    allEvents = data.events || [];
    document.getElementById('last-refresh').textContent = new Date().toLocaleString();
    document.getElementById('event-count').textContent = allEvents.length;
    render();
  };
  script.src = GAS_URL + '?action=fetch_data&pw=' + encodeURIComponent(TOKEN) + '&cb=' + cbName;
  script.onerror = function() { cleanup(); document.getElementById('ra-list').innerHTML = '<div class="loading" style="color:var(--warn);">Failed to load.</div>'; };
  document.head.appendChild(script);
}

// ── Main render ──
function render() {
  const confirms = allEvents.filter(e => e.event_type === 'confirm');
  const ras = [...new Set(confirms.map(e => e.ra))].filter(Boolean).sort();

  if (ras.length === 0) { document.getElementById('ra-list').innerHTML = ''; document.getElementById('no-data').style.display = 'block'; return; }
  document.getElementById('no-data').style.display = 'none';

  // Build shared items map for reliability
  const codingMap = {};
  confirms.forEach(e => {
    const vid = e.survey + '__' + e.var_id;
    if (!codingMap[vid]) codingMap[vid] = {};
    codingMap[vid][e.ra] = e.dimension || 'none';
  });
  const sharedItems = {};
  for (const vid in codingMap) { if (Object.keys(codingMap[vid]).length >= 2) sharedItems[vid] = codingMap[vid]; }

  // Alerts
  renderAlerts(ras, confirms);

  // RA sections
  const listEl = document.getElementById('ra-list');
  listEl.innerHTML = '';
  ras.forEach(ra => {
    const raConf = confirms.filter(e => e.ra === ra);
    const raAll = allEvents.filter(e => e.ra === ra);
    listEl.appendChild(buildRASection(ra, raConf, raAll, ras, sharedItems));
  });
}

// ── Alerts ──
function renderAlerts(ras, confirms) {
  const alertsEl = document.getElementById('alerts');
  const alerts = [];
  const now = Date.now();

  ras.forEach(ra => {
    const raConf = confirms.filter(e => e.ra === ra);
    const lastTs = raConf.reduce((m, e) => { const t = e.server_ts || ''; return t > m ? t : m; }, '');
    if (lastTs) {
      const daysSince = (now - new Date(lastTs).getTime()) / 86400000;
      if (daysSince > 3) alerts.push({ level: 'warn', msg: '<strong>' + esc(ra) + '</strong> hasn\'t submitted in ' + Math.floor(daysSince) + ' days — might need a check-in.' });
      else if (daysSince > 1) alerts.push({ level: 'caution', msg: '<strong>' + esc(ra) + '</strong> last submitted ' + Math.floor(daysSince) + ' day(s) ago.' });
    }
    // Speed alert: median < 2s is unusually fast
    const times = raConf.map(e => parseInt(e.view_ms) || 0).filter(t => t > 0 && t < 600000);
    if (times.length >= 10) {
      times.sort((a, b) => a - b);
      const median = times[Math.floor(times.length / 2)];
      if (median < 2000) alerts.push({ level: 'caution', msg: '<strong>' + esc(ra) + '</strong> averaging ' + fmtMs(median) + ' per item — faster than usual.' });
    }

    // Self-consistency alert
    const retestEvts = raConf.filter(e => e.retest === '1');
    if (retestEvts.length >= 5) {
      const conMatch = retestEvts.filter(e => e.dimension === e.original_answer).length;
      const conPct = Math.round(conMatch / retestEvts.length * 100);
      if (conPct < 60) alerts.push({ level: 'warn', msg: '<strong>' + esc(ra) + '</strong> self-consistency at ' + conPct + '% (' + retestEvts.length + ' retests) — may need guidance on dimension boundaries.' });
    }

    // Speed drift alert
    const normConf = raConf.filter(e => e.retest !== '1');
    if (normConf.length >= 30) {
      const midIdx = Math.floor(normConf.length / 2);
      const earlySpd = normConf.slice(0, midIdx).map(e => parseInt(e.view_ms) || 0).filter(t => t > 0 && t < 600000).sort((a, b) => a - b);
      const lateSpd = normConf.slice(midIdx).map(e => parseInt(e.view_ms) || 0).filter(t => t > 0 && t < 600000).sort((a, b) => a - b);
      if (earlySpd.length && lateSpd.length) {
        const eMed = earlySpd[Math.floor(earlySpd.length / 2)];
        const lMed = lateSpd[Math.floor(lateSpd.length / 2)];
        if (eMed > 0 && lMed < eMed * 0.4) alerts.push({ level: 'caution', msg: '<strong>' + esc(ra) + '</strong> recent pace (' + fmtMs(lMed) + '/item) is much faster than initial pace (' + fmtMs(eMed) + '/item).' });
      }
    }
  });

  alertsEl.innerHTML = alerts.map(a => '<div class="alert-bar ' + a.level + '">' + a.msg + '</div>').join('');
}

// ── Build one RA section ──
function buildRASection(ra, raConf, raAll, allRAs, sharedItems) {
  const section = document.createElement('div');
  section.className = 'ra-section';

  // Metrics
  const surveys = [...new Set(raConf.map(e => e.survey))].filter(Boolean);
  const lastTs = raConf.reduce((m, e) => { const t = e.server_ts || ''; return t > m ? t : m; }, '');
  const sessions = raAll.filter(e => e.event_type === 'session_start').length;
  const times = raConf.map(e => parseInt(e.view_ms) || 0).filter(t => t > 0 && t < 600000);
  times.sort((a, b) => a - b);
  const medianTime = times.length ? times[Math.floor(times.length / 2)] : 0;

  // Agreement with peers
  let agreePct = null, peerCount = 0;
  const otherRAs = allRAs.filter(r => r !== ra);
  if (otherRAs.length > 0) {
    let agree = 0, total = 0;
    for (const vid in sharedItems) {
      if (sharedItems[vid][ra] === undefined) continue;
      otherRAs.forEach(other => {
        if (sharedItems[vid][other] !== undefined) {
          total++;
          if (sharedItems[vid][ra] === sharedItems[vid][other]) agree++;
        }
      });
    }
    if (total > 0) { agreePct = Math.round(agree / total * 100); peerCount = total; }
  }

  // Badges
  const badges = [];
  const daysSince = lastTs ? (Date.now() - new Date(lastTs).getTime()) / 86400000 : 999;
  if (daysSince > 3) badges.push('<span class="badge badge-red">No activity ' + Math.floor(daysSince) + 'd</span>');
  else if (daysSince > 1) badges.push('<span class="badge badge-yellow">' + Math.floor(daysSince) + 'd ago</span>');
  else badges.push('<span class="badge badge-green">Active</span>');

  if (medianTime > 0 && medianTime < 2000) badges.push('<span class="badge badge-yellow">Fast pace</span>');
  if (agreePct !== null && agreePct < 60) badges.push('<span class="badge badge-red">Agreement ' + agreePct + '%</span>');
  else if (agreePct !== null && agreePct < 75) badges.push('<span class="badge badge-yellow">Agreement ' + agreePct + '%</span>');
  else if (agreePct !== null) badges.push('<span class="badge badge-green">Agreement ' + agreePct + '%</span>');

  // Self-consistency badge (from test-retest)
  const retestEvts = raConf.filter(e => e.retest === '1');
  if (retestEvts.length >= 5) {
    const conMatch = retestEvts.filter(e => e.dimension === e.original_answer).length;
    const conPct = Math.round(conMatch / retestEvts.length * 100);
    if (conPct < 60) badges.push('<span class="badge badge-red">Consistency ' + conPct + '%</span>');
    else if (conPct < 80) badges.push('<span class="badge badge-yellow">Consistency ' + conPct + '%</span>');
  }

  // Speed drift badge
  const normalConf = raConf.filter(e => e.retest !== '1');
  if (normalConf.length >= 20) {
    const midPt = Math.floor(normalConf.length / 2);
    const earlyTimes = normalConf.slice(0, midPt).map(e => parseInt(e.view_ms) || 0).filter(t => t > 0 && t < 600000).sort((a, b) => a - b);
    const lateTimes = normalConf.slice(midPt).map(e => parseInt(e.view_ms) || 0).filter(t => t > 0 && t < 600000).sort((a, b) => a - b);
    if (earlyTimes.length && lateTimes.length) {
      const earlyMed = earlyTimes[Math.floor(earlyTimes.length / 2)];
      const lateMed = lateTimes[Math.floor(lateTimes.length / 2)];
      if (earlyMed > 0 && lateMed < earlyMed * 0.5) badges.push('<span class="badge badge-yellow">Speeding up</span>');
    }
  }

  // Header
  const header = document.createElement('div');
  header.className = 'ra-header';
  header.innerHTML = `
    <div>
      <span class="ra-name">${esc(ra)}</span>
      <span class="ra-badges">${badges.join('')}</span>
    </div>
    <div class="ra-summary">
      <span><strong>${raConf.length}</strong> items</span>
      <span><strong>${surveys.length}</strong> surveys</span>
      <span><strong>${sessions}</strong> sessions</span>
      <span>${medianTime ? fmtMs(medianTime) + '/item' : '-'}</span>
      <span>${lastTs ? relTime(lastTs) : 'never'}</span>
    </div>`;

  // Detail panel
  const detail = document.createElement('div');
  detail.className = 'ra-detail';
  detail.innerHTML = buildRADetail(ra, raConf, raAll, allRAs, sharedItems, times);

  header.addEventListener('click', () => detail.classList.toggle('open'));
  section.appendChild(header);
  section.appendChild(detail);
  return section;
}

// ── RA detail content ──
function buildRADetail(ra, raConf, raAll, allRAs, sharedItems, times) {
  let html = '';

  // ── Metrics row ──
  const medianTime = times.length ? times[Math.floor(times.length / 2)] : 0;
  const meanTime = times.length ? Math.round(times.reduce((s, t) => s + t, 0) / times.length) : 0;
  const totalTime = times.reduce((s, t) => s + t, 0);
  const p90 = times.length ? times[Math.floor(times.length * 0.9)] : 0;
  const exports = raAll.filter(e => e.event_type === 'export').length;

  html += '<div class="metrics">';
  html += `<div class="metric"><div class="metric-num">${raConf.length}</div><div class="metric-lbl">Items Coded</div></div>`;
  html += `<div class="metric"><div class="metric-num">${fmtMs(medianTime)}</div><div class="metric-lbl">Median Time</div></div>`;
  html += `<div class="metric"><div class="metric-num">${fmtMs(p90)}</div><div class="metric-lbl">P90 Time</div></div>`;
  html += `<div class="metric"><div class="metric-num">${fmtDuration(totalTime)}</div><div class="metric-lbl">Total Time</div></div>`;
  html += `<div class="metric"><div class="metric-num">${exports}</div><div class="metric-lbl">Exports</div></div>`;
  html += '</div>';

  // ── Progress by survey ──
  html += '<div class="section-title">Progress by Survey</div>';
  const groups = {};
  raConf.forEach(e => {
    if (!groups[e.survey]) groups[e.survey] = { items: new Set(), first: e.server_ts, last: e.server_ts, totalVars: 0 };
    groups[e.survey].items.add(e.var_id);
    if (e.server_ts < groups[e.survey].first) groups[e.survey].first = e.server_ts;
    if (e.server_ts > groups[e.survey].last) groups[e.survey].last = e.server_ts;
    if (e.total_vars && parseInt(e.total_vars) > groups[e.survey].totalVars) groups[e.survey].totalVars = parseInt(e.total_vars);
  });
  html += '<table><tr><th>Survey</th><th>Items</th><th>First</th><th>Last</th><th>Completion</th></tr>';
  Object.keys(groups).sort().forEach(sv => {
    const g = groups[sv];
    const count = g.items.size;
    const total = g.totalVars || '?';
    const pct = g.totalVars ? Math.round(count / g.totalVars * 100) : null;
    const bar = pct !== null ? '<span class="pct-bar" style="width:' + Math.min(pct, 100) + 'px"></span> ' + pct + '%' : '-';
    html += '<tr><td>' + esc(sv) + '</td><td>' + count + (g.totalVars ? ' / ' + total : '') + '</td>';
    html += '<td class="mono">' + shortDate(g.first) + '</td><td class="mono">' + shortDate(g.last) + '</td><td>' + bar + '</td></tr>';
  });
  html += '</table>';

  // ── Dimension distribution ──
  html += '<div class="section-title">Dimension Distribution</div>';
  const dimCounts = {};
  ALL_DIMS.forEach(d => dimCounts[d] = 0);
  raConf.forEach(e => { const d = e.dimension || 'none'; dimCounts[d] = (dimCounts[d] || 0) + 1; });
  const totalCoded = raConf.length || 1;
  html += '<div style="display:flex; gap:0.4rem; flex-wrap:wrap; margin:0.3rem 0;">';
  ALL_DIMS.forEach(d => {
    if (dimCounts[d] > 0) {
      const pct = Math.round(dimCounts[d] / totalCoded * 100);
      html += '<span class="dim-tag" style="background:' + DIM_COLORS[d] + '">' + (DIM_LABELS[d] || d) + ' ' + dimCounts[d] + ' (' + pct + '%)</span> ';
    }
  });
  html += '</div>';

  // ── Activity hours ──
  html += '<div class="section-title">Activity by Hour</div>';
  const hourCounts = new Array(24).fill(0);
  raConf.forEach(e => { if (e.server_ts) { const h = new Date(e.server_ts).getHours(); if (!isNaN(h)) hourCounts[h]++; } });
  const maxH = Math.max(...hourCounts, 1);
  html += '<div class="hour-chart">';
  for (let h = 0; h < 24; h++) html += '<div class="hour-bar" style="height:' + (hourCounts[h] / maxH * 100) + '%; background:' + (hourCounts[h] > 0 ? 'var(--navy)' : 'var(--cream)') + ';"></div>';
  html += '</div><div class="hour-labels">';
  for (let h = 0; h < 24; h++) html += '<span>' + (h % 3 === 0 ? h : '') + '</span>';
  html += '</div>';

  // ── Self-Consistency (Test-Retest) ──
  const retests = raConf.filter(e => e.retest === '1');
  if (retests.length > 0) {
    html += '<div class="section-title">Self-Consistency (Test-Retest)</div>';
    html += '<p class="note">Items randomly re-presented without showing the previous answer. Measures intra-coder reliability.</p>';
    let conMatch = 0;
    retests.forEach(e => { if (e.dimension === e.original_answer) conMatch++; });
    const conPct = Math.round(conMatch / retests.length * 100);
    const conClass = conPct >= 80 ? 'ok-text' : conPct < 60 ? 'warn-text' : '';
    html += '<div class="metrics">';
    html += '<div class="metric"><div class="metric-num">' + retests.length + '</div><div class="metric-lbl">Retests</div></div>';
    html += '<div class="metric"><div class="metric-num ' + conClass + '">' + conPct + '%</div><div class="metric-lbl">Consistent</div></div>';
    html += '</div>';

    // Per-dimension consistency
    const dimRt = {};
    retests.forEach(e => {
      const oa = e.original_answer || 'none';
      if (!dimRt[oa]) dimRt[oa] = { total: 0, match: 0 };
      dimRt[oa].total++;
      if (e.dimension === oa) dimRt[oa].match++;
    });
    if (Object.keys(dimRt).length > 1) {
      html += '<table><tr><th>Original Dimension</th><th>Retests</th><th>Consistent</th></tr>';
      ALL_DIMS.forEach(d => {
        if (!dimRt[d]) return;
        const dr = dimRt[d];
        const pct = Math.round(dr.match / dr.total * 100);
        html += '<tr><td><span class="dim-tag" style="background:' + DIM_COLORS[d] + '">' + DIM_LABELS[d] + '</span></td>';
        html += '<td>' + dr.total + '</td>';
        html += '<td class="' + (pct >= 80 ? 'ok-text' : pct < 60 ? 'warn-text' : '') + '">' + pct + '% (' + dr.match + '/' + dr.total + ')</td></tr>';
      });
      html += '</table>';
    }
  }

  // ── Coding Trends (Drift Detection) ──
  const driftConf = raConf.filter(e => e.retest !== '1');
  if (driftConf.length >= 20) {
    html += '<div class="section-title">Coding Trends</div>';
    html += '<p class="note">Compares first half vs recent half to detect changes in speed or dimension preference.</p>';
    const midPt = Math.floor(driftConf.length / 2);
    const firstHalf = driftConf.slice(0, midPt);
    const secondHalf = driftConf.slice(midPt);

    // Speed comparison
    const speedFirst = firstHalf.map(e => parseInt(e.view_ms) || 0).filter(t => t > 0 && t < 600000).sort((a, b) => a - b);
    const speedSecond = secondHalf.map(e => parseInt(e.view_ms) || 0).filter(t => t > 0 && t < 600000).sort((a, b) => a - b);
    const medFirst = speedFirst.length ? speedFirst[Math.floor(speedFirst.length / 2)] : 0;
    const medSecond = speedSecond.length ? speedSecond[Math.floor(speedSecond.length / 2)] : 0;
    const speedChange = medFirst > 0 ? Math.round((medSecond - medFirst) / medFirst * 100) : 0;
    const speedArrow = speedChange < -20 ? 'faster' : speedChange > 20 ? 'slower' : 'stable';
    const speedCls = Math.abs(speedChange) > 30 ? 'warn-text' : 'muted';

    html += '<table><tr><th>Metric</th><th>First Half (' + firstHalf.length + ')</th><th>Recent Half (' + secondHalf.length + ')</th><th>Trend</th></tr>';
    html += '<tr><td>Median Speed</td><td>' + fmtMs(medFirst) + '</td><td>' + fmtMs(medSecond) + '</td>';
    html += '<td class="' + speedCls + '">' + (speedChange > 0 ? '+' : '') + speedChange + '% ' + speedArrow + '</td></tr>';

    // Dimension distribution comparison — biggest shift
    const dimFirst = {}, dimSecond = {};
    ALL_DIMS.forEach(d => { dimFirst[d] = 0; dimSecond[d] = 0; });
    firstHalf.forEach(e => { dimFirst[e.dimension || 'none']++; });
    secondHalf.forEach(e => { dimSecond[e.dimension || 'none']++; });
    let maxShift = 0, shiftDim = '';
    ALL_DIMS.forEach(d => {
      const p1 = firstHalf.length ? dimFirst[d] / firstHalf.length * 100 : 0;
      const p2 = secondHalf.length ? dimSecond[d] / secondHalf.length * 100 : 0;
      const shift = Math.abs(p2 - p1);
      if (shift > maxShift) { maxShift = shift; shiftDim = d; }
    });
    if (maxShift > 10) {
      const p1 = Math.round(dimFirst[shiftDim] / firstHalf.length * 100);
      const p2 = Math.round(dimSecond[shiftDim] / secondHalf.length * 100);
      html += '<tr><td>Biggest Shift</td>';
      html += '<td><span class="dim-tag" style="background:' + DIM_COLORS[shiftDim] + '">' + DIM_LABELS[shiftDim] + '</span> ' + p1 + '%</td>';
      html += '<td><span class="dim-tag" style="background:' + DIM_COLORS[shiftDim] + '">' + DIM_LABELS[shiftDim] + '</span> ' + p2 + '%</td>';
      html += '<td class="' + (maxShift > 15 ? 'warn-text' : 'muted') + '">' + (p2 > p1 ? '+' : '') + Math.round(p2 - p1) + 'pp</td></tr>';
    }
    html += '</table>';
  }

  // ── Agreement with each peer ──
  const otherRAs = allRAs.filter(r => r !== ra);
  if (otherRAs.length > 0) {
    html += '<div class="section-title">Agreement with Peers</div>';

    // Per-peer summary
    html += '<table><tr><th>Peer</th><th>Shared Items</th><th>Agree %</th><th>Cohen\'s Kappa</th><th>Worst Dimension</th></tr>';
    otherRAs.forEach(peer => {
      const pairItems = [];
      for (const vid in sharedItems) {
        if (sharedItems[vid][ra] !== undefined && sharedItems[vid][peer] !== undefined) {
          pairItems.push({ a: sharedItems[vid][ra], b: sharedItems[vid][peer], vid });
        }
      }
      if (pairItems.length === 0) { html += '<tr><td>' + esc(peer) + '</td><td colspan="4" class="muted">No shared items</td></tr>'; return; }

      const agree = pairItems.filter(p => p.a === p.b).length;
      const agreePct = Math.round(agree / pairItems.length * 100);
      const kappa = computeCohenKappa(pairItems.map(p => p.a), pairItems.map(p => p.b), ALL_DIMS);

      // Find worst dimension (most disagreements)
      const dimDisagree = {};
      ALL_DIMS.forEach(d => dimDisagree[d] = 0);
      pairItems.forEach(p => {
        if (p.a !== p.b) {
          dimDisagree[p.a] = (dimDisagree[p.a] || 0) + 1;
          dimDisagree[p.b] = (dimDisagree[p.b] || 0) + 1;
        }
      });
      let worstDim = '', worstCount = 0;
      ALL_DIMS.forEach(d => { if (dimDisagree[d] > worstCount) { worstDim = d; worstCount = dimDisagree[d]; } });

      const agreeClass = agreePct >= 80 ? 'ok-text' : agreePct < 60 ? 'warn-text' : '';
      const kappaClass = kappa >= 0.8 ? 'ok-text' : kappa < 0.6 ? 'warn-text' : '';

      html += '<tr><td>' + esc(peer) + '</td><td>' + pairItems.length + '</td>';
      html += '<td class="' + agreeClass + '">' + agreePct + '%</td>';
      html += '<td class="' + kappaClass + '">' + kappa.toFixed(3) + '</td>';
      html += '<td>' + (worstCount > 0 ? '<span class="dim-tag" style="background:' + DIM_COLORS[worstDim] + '">' + DIM_LABELS[worstDim] + '</span> ' + worstCount + ' disputes' : '<span class="muted">-</span>') + '</td></tr>';
    });
    html += '</table>';

    // Per-dimension reliability for this RA
    html += '<div class="section-title">Per-Dimension Reliability</div>';
    html += '<p class="note">Binary: does this RA agree with peers on whether each item belongs to this dimension?</p>';
    html += '<table><tr><th>Dimension</th><th>Items</th><th>Agree %</th><th>Kappa</th><th>This RA codes more?</th></tr>';
    ALL_DIMS.forEach(dim => {
      let agree = 0, total = 0, raCodes = 0, peersCodes = 0;
      for (const vid in sharedItems) {
        if (sharedItems[vid][ra] === undefined) continue;
        const raYes = sharedItems[vid][ra] === dim;
        otherRAs.forEach(peer => {
          if (sharedItems[vid][peer] === undefined) return;
          const peerYes = sharedItems[vid][peer] === dim;
          total++;
          if (raYes === peerYes) agree++;
          if (raYes) raCodes++;
          if (peerYes) peersCodes++;
        });
      }
      if (total === 0) return;
      const agPct = Math.round(agree / total * 100);
      // Binary kappa
      let tp = 0, fp = 0, fn = 0, tn = 0;
      for (const vid in sharedItems) {
        if (sharedItems[vid][ra] === undefined) continue;
        otherRAs.forEach(peer => {
          if (sharedItems[vid][peer] === undefined) return;
          const a = sharedItems[vid][ra] === dim, b = sharedItems[vid][peer] === dim;
          if (a && b) tp++; else if (a && !b) fn++; else if (!a && b) fp++; else tn++;
        });
      }
      const n = tp + fp + fn + tn;
      const po = (tp + tn) / n;
      const pe = ((tp + fn) / n) * ((tp + fp) / n) + ((fp + tn) / n) * ((fn + tn) / n);
      const kappa = pe < 1 ? (po - pe) / (1 - pe) : 1;

      const bias = raCodes > peersCodes * 1.3 ? '<span class="warn-text">Over-codes</span>'
        : raCodes < peersCodes * 0.7 ? '<span class="warn-text">Under-codes</span>'
        : '<span class="muted">Balanced</span>';

      html += '<tr><td><span class="dim-tag" style="background:' + DIM_COLORS[dim] + '">' + DIM_LABELS[dim] + '</span></td>';
      html += '<td>' + total + '</td>';
      html += '<td class="' + (agPct >= 80 ? 'ok-text' : agPct < 60 ? 'warn-text' : '') + '">' + agPct + '%</td>';
      html += '<td class="' + (kappa >= 0.8 ? 'ok-text' : kappa < 0.6 ? 'warn-text' : '') + '">' + kappa.toFixed(3) + '</td>';
      html += '<td>' + bias + '</td></tr>';
    });
    html += '</table>';

    // Disagreed items for this RA
    const disagreed = [];
    for (const vid in sharedItems) {
      if (sharedItems[vid][ra] === undefined) continue;
      const raCode = sharedItems[vid][ra];
      const peerCodes = otherRAs.filter(p => sharedItems[vid][p] !== undefined).map(p => sharedItems[vid][p]);
      if (peerCodes.length > 0 && peerCodes.every(c => c !== raCode)) {
        disagreed.push({ vid, raCode, peerCodes });
      }
    }
    if (disagreed.length > 0) {
      html += '<div class="section-title">Items to Review <span class="badge badge-yellow">' + disagreed.length + '</span></div>';
      html += '<p class="note">Items where this coder\'s choice differs from all other coders. May be worth a conversation.</p>';
      html += '<table><tr><th>Variable</th><th>' + esc(ra) + '</th><th>Peers say</th></tr>';
      disagreed.slice(0, 30).forEach(d => {
        const peerDim = d.peerCodes[0];
        html += '<tr><td class="mono">' + esc(d.vid) + '</td>';
        html += '<td><span class="dim-tag" style="background:' + DIM_COLORS[d.raCode] + '">' + DIM_LABELS[d.raCode] + '</span></td>';
        html += '<td><span class="dim-tag" style="background:' + DIM_COLORS[peerDim] + '">' + DIM_LABELS[peerDim] + '</span></td></tr>';
      });
      html += '</table>';
      if (disagreed.length > 30) html += '<p class="note">Showing 30 of ' + disagreed.length + '.</p>';
    }
  }

  return html;
}

// ── Statistics ──
function computeCohenKappa(ratingsA, ratingsB, categories) {
  const n = ratingsA.length; if (n === 0) return 0;
  let agree = 0;
  for (let i = 0; i < n; i++) { if (ratingsA[i] === ratingsB[i]) agree++; }
  const po = agree / n;
  let pe = 0;
  categories.forEach(cat => { pe += (ratingsA.filter(r => r === cat).length / n) * (ratingsB.filter(r => r === cat).length / n); });
  return pe < 1 ? (po - pe) / (1 - pe) : 1;
}

// ── Helpers ──
function fmtMs(ms) { if (!ms || ms <= 0) return '-'; if (ms < 1000) return ms + 'ms'; return (ms / 1000).toFixed(1) + 's'; }
function fmtDuration(ms) { if (!ms) return '-'; const m = Math.floor(ms / 60000); const h = Math.floor(m / 60); return h > 0 ? h + 'h ' + (m % 60) + 'm' : m + 'm'; }
function shortDate(ts) { if (!ts) return '-'; const d = new Date(ts); return d.getMonth() + 1 + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0'); }
function relTime(ts) { const d = (Date.now() - new Date(ts).getTime()) / 1000; if (d < 60) return 'just now'; if (d < 3600) return Math.floor(d / 60) + 'm ago'; if (d < 86400) return Math.floor(d / 3600) + 'h ago'; return Math.floor(d / 86400) + 'd ago'; }
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function downloadCSV() {
  if (allEvents.length === 0) return;
  const headers = ['server_ts','event_type','ra','survey','var_id','dimension','concept','view_ms','session_id','coded_count','total_vars','retest','original_answer'];
  let csv = headers.join(',') + '\n';
  allEvents.forEach(e => { csv += headers.map(h => '"' + String(e[h] || '').replace(/"/g, '""') + '"').join(',') + '\n'; });
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'coding_events_' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
}
</script>
</body>
</html>
