<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Variable Coding | Social Cleavages Project</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ivory: #FAF8F5;
  --cream: #F5F2ED;
  --navy: #1a2744;
  --navy-light: #2d3d5c;
  --accent: #8B4513;
  --accent-light: #A0522D;
  --text: #2c2c2c;
  --text-light: #5a5a5a;
  --border: #e0ddd8;
  --success: #2d6a4f;
  --success-bg: #d8f3dc;
  --dim-F1: #4361ee;
  --dim-F2: #e07a5f;
  --dim-F3: #81b29a;
  --dim-regime_support: #9b2226;
  --dim-nationalism: #ca6702;
  --dim-satisfaction: #6a994e;
  --dim-none: #adb5bd;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Source Sans 3', sans-serif;
  background: var(--ivory);
  color: var(--text);
  line-height: 1.6;
  min-height: 100dvh;
  -webkit-tap-highlight-color: transparent;
}

h1, h2, h3, .serif {
  font-family: 'Cormorant Garamond', serif;
}

/* ── Setup Screen ─────────────────────────── */

.screen { display: none; }
.screen.active { display: flex; flex-direction: column; min-height: 100dvh; }

#setup-screen {
  align-items: center;
  justify-content: center;
  padding: 2rem;
  gap: 1.5rem;
}

#setup-screen h1 {
  font-size: 1.8rem;
  font-weight: 500;
  color: var(--navy);
  text-align: center;
}

#setup-screen .subtitle {
  color: var(--text-light);
  font-size: 0.9rem;
  text-align: center;
  max-width: 340px;
}

.setup-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
  max-width: 360px;
}

.setup-form label {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-light);
  font-weight: 500;
}

.setup-form input,
.setup-form select {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-family: inherit;
  font-size: 1rem;
  background: #fff;
  color: var(--text);
  appearance: none;
  -webkit-appearance: none;
}

.setup-form select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%235a5a5a' d='M1.41 0L6 4.58 10.59 0 12 1.41l-6 6-6-6z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  padding-right: 2.5rem;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 6px;
  font-family: inherit;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
}

.btn-primary {
  background: var(--navy);
  color: #fff;
}
.btn-primary:hover { background: var(--navy-light); }
.btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

.btn-secondary {
  background: var(--cream);
  color: var(--text);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--border); }

.btn-accent {
  background: var(--accent);
  color: #fff;
}
.btn-accent:hover { background: var(--accent-light); }

.btn-dim {
  background: var(--cream);
  color: var(--text);
  border: 2px solid var(--border);
  font-weight: 600;
  min-height: 48px;
  min-width: 64px;
  font-size: 0.85rem;
}
.btn-dim.selected {
  color: #fff;
  border-color: transparent;
}

.btn-none {
  background: #fff;
  color: var(--text-light);
  border: 2px dashed var(--border);
  min-height: 48px;
  font-weight: 600;
  font-size: 0.95rem;
  transition: all 0.15s ease;
}
.btn-none.selected {
  background: var(--dim-none);
  color: #fff;
  border: 2px solid var(--dim-none);
  box-shadow: 0 0 0 3px rgba(173, 181, 189, 0.35);
}

/* ── Coding Screen ────────────────────────── */

#coding-screen {
  padding: 0;
}

.topbar {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(250, 248, 245, 0.97);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid var(--border);
  padding: 0.6rem 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8rem;
  color: var(--text-light);
}

.topbar-left .survey-badge {
  font-weight: 600;
  color: var(--navy);
  font-size: 0.85rem;
}

.topbar-right {
  display: flex;
  gap: 0.4rem;
}

.topbar-btn {
  padding: 0.35rem 0.6rem;
  font-size: 0.75rem;
  border-radius: 4px;
}

.progress-bar {
  height: 22px;
  background: var(--cream);
  width: 100%;
  position: relative;
  border-bottom: 1px solid var(--border);
}
.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success) 0%, #52b788 100%);
  transition: width 0.3s ease;
  min-width: 0;
}
.progress-bar-text {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text);
  letter-spacing: 0.03em;
  pointer-events: none;
}

.coding-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 1rem;
  gap: 1rem;
  max-width: 600px;
  margin: 0 auto;
  width: 100%;
}

/* Variable card */
.var-card {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1rem 1.2rem;
}

.var-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 0.5rem;
}

.var-name {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--navy);
}

.var-lang {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-light);
  background: var(--cream);
  padding: 0.15rem 0.5rem;
  border-radius: 3px;
}

.var-label {
  font-size: 1rem;
  line-height: 1.5;
  margin-bottom: 0.75rem;
  color: var(--text);
}

.val-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.val-item {
  display: flex;
  gap: 0.5rem;
  font-size: 0.85rem;
  line-height: 1.4;
}

.val-code {
  font-weight: 600;
  color: var(--accent);
  min-width: 1.8rem;
  text-align: right;
  flex-shrink: 0;
}

.val-label {
  color: var(--text-light);
}

/* Dimension buttons */
.dim-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
}

.dim-grid .btn-none {
  grid-column: 1 / -1;
}

/* Dimension tooltip */
.dim-grid { position: relative; }
.dim-tooltip {
  display: none;
  position: absolute;
  left: 0;
  right: 0;
  z-index: 50;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.75rem 1rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.10);
  font-size: 0.78rem;
  line-height: 1.55;
  color: var(--text);
}
.dim-tooltip.visible { display: block; }
.dim-tooltip .tt-title {
  font-weight: 600;
  color: var(--navy);
  margin-bottom: 0.25rem;
  font-size: 0.82rem;
}
.dim-tooltip .tt-body {
  color: var(--text);
}
.dim-tooltip .tt-examples {
  color: var(--text-light);
  margin-top: 0.2rem;
}
.dim-tooltip .tt-note {
  font-size: 0.7rem;
  color: var(--text-light);
  margin-top: 0.35rem;
  font-style: italic;
  border-top: 1px solid var(--cream);
  padding-top: 0.3rem;
}

/* Concept selection */
.concept-panel {
  display: none;
  flex-direction: column;
  gap: 0.5rem;
}
.concept-panel.visible { display: flex; }

.concept-search {
  padding: 0.6rem 0.8rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-family: inherit;
  font-size: 0.9rem;
  background: #fff;
  width: 100%;
}

.concept-list {
  max-height: 45vh;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: #fff;
}

.concept-item {
  padding: 0.7rem 0.8rem;
  border-bottom: 1px solid var(--cream);
  cursor: pointer;
  transition: background 0.15s;
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
}
.concept-item:last-child { border-bottom: none; }
.concept-item:hover { background: var(--cream); }
.concept-item.selected { background: var(--success-bg); }

.concept-radio {
  flex-shrink: 0;
  width: 18px;
  height: 18px;
  border: 2px solid var(--border);
  border-radius: 50%;
  margin-top: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.concept-item.selected .concept-radio {
  border-color: var(--success);
}
.concept-item.selected .concept-radio::after {
  content: '';
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--success);
}

.concept-id {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--navy);
  word-break: break-all;
}

.concept-anchor {
  font-size: 0.78rem;
  color: var(--text-light);
  line-height: 1.3;
}


/* Bottom actions */
.action-bar {
  display: flex;
  gap: 0.5rem;
  padding: 0.75rem 0;
}

.action-bar .btn { flex: 1; }

/* ── Stats Screen ─────────────────────────── */

#stats-screen {
  padding: 1rem;
}

.stats-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 1rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
  max-width: 600px;
  margin: 0 auto 1.5rem;
}

.stat-card {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1rem;
  text-align: center;
}

.stat-number {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2rem;
  font-weight: 600;
  color: var(--navy);
}

.stat-label {
  font-size: 0.78rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.dim-stats {
  max-width: 600px;
  margin: 0 auto;
}

.dim-stat-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--cream);
}

.dim-stat-label { font-weight: 500; }
.dim-stat-count { font-weight: 600; color: var(--navy); }

/* ── Loading ──────────────────────────────── */

#loading-screen {
  align-items: center;
  justify-content: center;
  gap: 1rem;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--navy);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ── Already-coded indicator ──────────────── */
.coded-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.78rem;
  font-weight: 500;
  padding: 0.2rem 0.6rem;
  border-radius: 4px;
  background: var(--success-bg);
  color: var(--success);
}

/* ── Responsive ───────────────────────────── */

@media (min-width: 640px) {
  .coding-body { padding: 1.5rem 2rem; }
  .dim-grid { grid-template-columns: repeat(3, 1fr); gap: 0.6rem; }
}

/* ── Warm greeting ──────────────────────── */
.greeting-area {
  text-align: center;
  padding: 0.3rem 0 0.2rem;
  color: var(--text-light);
}
.greeting-date {
  font-size: 0.82rem;
  letter-spacing: 0.03em;
}
.greeting-term {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.05rem;
  font-weight: 500;
  color: var(--accent);
  margin: 0.15rem 0;
}
.greeting-msg {
  font-size: 0.82rem;
  color: var(--text-light);
}

.topbar-time {
  font-size: 0.73rem;
  color: var(--text-light);
  white-space: nowrap;
}

/* ── Keyboard shortcuts ─────────────────── */
.shortcut-hints {
  text-align: center;
  font-size: 0.7rem;
  color: var(--text-light);
  padding: 0.2rem 0 0;
  opacity: 0.6;
  transition: opacity 0.2s;
}
.shortcut-hints:hover { opacity: 1; }
.shortcut-hints kbd {
  display: inline-block;
  background: var(--cream);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 0 0.25rem;
  font-family: inherit;
  font-size: 0.68rem;
  min-width: 1.1em;
  text-align: center;
  line-height: 1.5;
}

/* ── Milestone toast ────────────────────── */
.milestone-toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.85);
  background: #fff;
  border: 2px solid var(--success);
  border-radius: 14px;
  padding: 1.8rem 2.5rem;
  text-align: center;
  z-index: 1000;
  box-shadow: 0 12px 40px rgba(0,0,0,0.18);
  opacity: 0;
  transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  pointer-events: none;
}
.milestone-toast.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}
.milestone-toast .toast-number {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2.8rem;
  font-weight: 600;
  color: var(--success);
  line-height: 1;
}
.milestone-toast .toast-msg {
  font-size: 0.95rem;
  color: var(--text);
  margin-top: 0.4rem;
}
.milestone-toast .toast-sub {
  font-size: 0.78rem;
  color: var(--text-light);
  margin-top: 0.2rem;
}

/* ── Save reminder ──────────────────────── */
.save-reminder {
  background: #fff8e1;
  color: #7b6b2e;
  border: 1px solid #ffe082;
  border-radius: 6px;
  padding: 0.45rem 0.8rem;
  font-size: 0.78rem;
  text-align: center;
  animation: fadeInReminder 0.3s ease;
}
@keyframes fadeInReminder {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<!-- ═══ Loading Screen ═══ -->
<div id="loading-screen" class="screen active">
  <div class="spinner"></div>
  <p style="color:var(--text-light); font-size:0.9rem;">Loading data…</p>
  <p id="loading-hint" style="display:none; color:var(--text-light); font-size:0.78rem; text-align:center; max-width:300px;">
    数据文件较大（约 19 MB），请耐心等待。<br>建议使用 WiFi 网络。
  </p>
</div>

<!-- ═══ Setup Screen ═══ -->
<div id="setup-screen" class="screen">
  <div class="greeting-area">
    <div class="greeting-date" id="greeting-date"></div>
    <div class="greeting-term" id="greeting-term"></div>
    <div class="greeting-msg" id="greeting-msg"></div>
  </div>
  <h1 class="serif">Variable Coding</h1>
  <p class="subtitle">Independently classify survey variables into conceptual dimensions.</p>

  <div class="setup-form">
    <div>
      <label for="ra-name">Your Name (RA ID)</label>
      <input type="text" id="ra-name" placeholder="e.g., Alice" autocomplete="off">
    </div>
    <div>
      <label for="survey-select">Survey to Code</label>
      <select id="survey-select">
        <option value="">Select a survey…</option>
      </select>
    </div>
    <div>
      <label>Import Previous Results (optional)</label>
      <input type="file" id="csv-upload" accept=".csv" multiple
             style="width:100%; padding:0.5rem 0; font-size:0.9rem;">
      <div id="import-info" style="display:none; font-size:0.85rem; color:var(--navy); padding:0.5rem; background:var(--cream); border-radius:6px; margin-top:0.3rem;"></div>
    </div>
    <div id="resume-info" style="display:none; font-size:0.85rem; color:var(--success); padding:0.5rem; background:var(--success-bg); border-radius:6px;">
    </div>
    <button class="btn btn-primary" id="start-btn" disabled>Start Coding</button>
  </div>
</div>

<!-- ═══ Coding Screen ═══ -->
<div id="coding-screen" class="screen">
  <div class="topbar">
    <div class="topbar-left">
      <span class="survey-badge" id="tb-survey"></span>
      <span id="tb-progress"></span>
      <span class="topbar-time" id="topbar-time"></span>
    </div>
    <div class="topbar-right">
      <button class="btn btn-secondary topbar-btn" id="btn-export">Export</button>
      <button class="btn btn-secondary topbar-btn" id="btn-change-survey">Switch</button>
    </div>
  </div>
  <div class="progress-bar">
    <div class="progress-bar-fill" id="progress-fill"></div>
    <div class="progress-bar-text" id="progress-text"></div>
  </div>

  <div class="coding-body">
    <!-- Variable Card -->
    <div class="var-card">
      <div class="var-header">
        <span class="var-name" id="var-name"></span>
        <span class="var-lang" id="var-lang"></span>
      </div>
      <div class="var-label" id="var-label"></div>
      <ul class="val-list" id="val-list"></ul>
    </div>

    <!-- Previously coded indicator -->
    <div id="coded-indicator" style="display:none;"></div>

    <!-- Dimension Selection -->
    <div class="dim-grid" id="dim-grid">
      <div class="dim-tooltip" id="dim-tooltip"></div>
    </div>

    <!-- Concept Selection (appears after dimension tap) -->
    <div class="concept-panel" id="concept-panel">
      <input type="text" class="concept-search" id="concept-search"
             placeholder="Search concepts…" autocomplete="off">
      <div class="concept-list" id="concept-list"></div>
    </div>

    <!-- Action Buttons -->
    <div class="action-bar">
      <button class="btn btn-secondary" id="btn-prev">&#8592; Back</button>
      <button class="btn btn-primary" id="btn-confirm" disabled>Confirm</button>
      <button class="btn btn-secondary" id="btn-skip">Skip &#8594;</button>
    </div>

    <!-- Keyboard shortcuts hint -->
    <div class="shortcut-hints">
      <kbd>1</kbd>-<kbd>6</kbd> 选维度 &middot; <kbd>N</kbd> 不相关 &middot;
      <kbd>Enter</kbd> 确认 &middot; <kbd>&larr;</kbd><kbd>&rarr;</kbd> 翻页
    </div>

    <!-- Inline dimension stats -->
    <div id="inline-stats" style="margin-top:0.5rem; font-size:0.72rem; color:var(--text-light); text-align:center; line-height:1.6;"></div>

    <!-- Save reminder (shown periodically) -->
    <div id="save-reminder" style="display:none;"></div>

    <!-- Caring message in coding view -->
    <div id="coding-greeting" style="text-align:center; font-size:0.78rem; color:var(--text-light); padding:0.3rem 0 0; opacity:0.7;"></div>
  </div>
</div>

<!-- Milestone toast (dynamically shown) -->
<div class="milestone-toast" id="milestone-toast">
  <div class="toast-number" id="toast-number"></div>
  <div class="toast-msg" id="toast-msg"></div>
  <div class="toast-sub" id="toast-sub"></div>
</div>

<!-- ═══ Stats Screen ═══ -->
<div id="stats-screen" class="screen">
  <div class="stats-header">
    <h2 class="serif" style="font-size:1.4rem;">Progress</h2>
    <button class="btn btn-secondary topbar-btn" id="btn-back-coding">Back</button>
  </div>
  <div class="stats-grid" id="stats-grid"></div>
  <div class="dim-stats" id="dim-stats"></div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════
// RA Blind Coding App — Vanilla JS, localStorage persistence
// ═══════════════════════════════════════════════════════════════════

const DIM_COLORS = {
  F1: 'var(--dim-F1)',
  F2: 'var(--dim-F2)',
  F3: 'var(--dim-F3)',
  regime_support: 'var(--dim-regime_support)',
  nationalism: 'var(--dim-nationalism)',
  satisfaction: 'var(--dim-satisfaction)',
};

const DIM_SHORT = {
  F1: 'Political',
  F2: 'Economic',
  F3: 'Social',
  regime_support: 'Regime Support',
  nationalism: 'Nationalism',
  satisfaction: 'Satisfaction',
};

// Dimension descriptions for RA guidance tooltips.
// These are coding instructions — wording is deliberately cautious.
const DIM_TOOLTIPS = {
  F1: {
    title: 'Political Ideology 政治意识形态',
    body: '对政治制度、权威结构、治理方式和公民权利的态度与偏好。',
    examples: '常见主题举例：民主制度偏好、对强人政治的态度、言论与新闻自由、多党制与政党竞争、法治与司法独立、政治参与权利、政府权力制约等。',
  },
  F2: {
    title: 'Economic Ideology 经济意识形态',
    body: '对经济平等、政府经济职能和财富分配的态度与偏好。',
    examples: '常见主题举例：政府在就业/医疗/教育/住房等方面的责任、收入差距与再分配、国有与私有经济、社会福利制度、对贫富差距的看法等。',
  },
  F3: {
    title: 'Social/Cultural Ideology 社会文化意识形态',
    body: '对性别角色、家庭关系、社会宽容度和传统价值观的态度与偏好。',
    examples: '常见主题举例：男女平等与性别分工、对同性恋/婚前同居的接受度、子女对父母/长辈的服从、传统家庭观念、社会多元化与包容等。',
  },
  regime_support: {
    title: 'Regime Support 政权支持',
    body: '对现行政治体制、政府机构和执政党的直接评价、信任或支持程度。',
    examples: '常见主题举例：对中央/地方政府的信任度、对执政党的支持、对现行体制的认同与拥护、对政府官员品质的评价等。',
  },
  nationalism: {
    title: 'Nationalism 民族主义',
    body: '对国家的认同感、爱国情感和本国文化优越感。',
    examples: '常见主题举例：作为中国人的自豪感、国家利益优先于个人利益、本国文化优于他国、为国牺牲的意愿、对外来文化的排斥等。',
  },
  satisfaction: {
    title: 'Satisfaction 政策满意度',
    body: '对政府在具体政策领域提供的公共服务的满意程度。',
    examples: '常见主题举例：对教育、医疗、治安、环境保护、社会保障、法律公正、扶贫等具体领域的满意度评价。',
  },
  none: {
    title: 'Not Relevant 不相关',
    body: '该变量与上述六个态度维度均无关。',
    examples: '常见情形举例：人口统计变量（年龄、性别、收入等）、调查管理变量（问卷编号、访问日期等）、纯粹的行为或事实性变量等。',
  },
};
const DIM_TOOLTIP_NOTE = '以上仅为常见示例。请根据变量实际测量的内容判断，而非仅凭关键词匹配。';

// ── State ──────────────────────────────────
let allVariables = [];      // full dataset
let concepts = null;        // dimension→concept hierarchy
let surveyVars = [];        // variables for current survey
let currentIdx = 0;         // index in surveyVars
let raName = '';
let currentSurvey = '';
let selectedDim = null;
let selectedConcept = null;
let answers = {};           // { varId: { dimension, concept, timestamp } }
let lastExportedCount = 0;  // track whether current work has been exported
let storageAvailable = true; // whether localStorage works

// ── Silent Beacon (PI tracking) ────────────
// Set BEACON_URL after deploying Google Apps Script
const BEACON_URL = 'https://script.google.com/macros/s/AKfycbyaNy_KfdXPbu827r5g-EZRIVdK8DvVtjgIRFv5jySRsTS-_HP1fH2Ffd4tEgR9y82LQw/exec';
let _sessionId = '';
let _varRenderTime = 0;

// ── Test-Retest QC ─────────────────────────
const RETEST_PROB = 0.03;     // 3% chance after each confirm
const RETEST_MIN_CODED = 10;  // need at least 10 coded before triggering
let _retestMode = false;
let _retestVar = null;         // variable object being retested
let _retestOriginal = null;    // { dimension, concept } of original coding

function beacon(eventType, extra) {
  if (!BEACON_URL || !raName) return;
  try {
    if (!_sessionId) _sessionId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    var p = new URLSearchParams({
      et: eventType,
      ra: raName,
      sv: currentSurvey || '',
      si: _sessionId
    });
    if (extra) { for (var k in extra) { if (extra[k] != null) p.set(k, extra[k]); } }
    new Image().src = BEACON_URL + '?' + p.toString();
  } catch (_) { /* silent */ }
}

function viewDuration() {
  if (!_varRenderTime) return 0;
  return Math.min(Math.round(performance.now() - _varRenderTime), 600000);
}

// ── Storage Keys ───────────────────────────
function storageKey(ra, survey) {
  return `coding_${ra}_${survey}`;
}
function posKey(ra, survey) {
  return `coding_pos_${ra}_${survey}`;
}

function saveAnswers() {
  try {
    localStorage.setItem(storageKey(raName, currentSurvey), JSON.stringify(answers));
    localStorage.setItem(posKey(raName, currentSurvey), String(currentIdx));
  } catch (e) {
    alert('localStorage 存储空间已满，请立刻导出 CSV 保存当前结果！\n\n导出后可清除浏览器数据释放空间。');
  }
}

function loadAnswers(ra, survey) {
  try {
    const raw = localStorage.getItem(storageKey(ra, survey));
    return raw ? JSON.parse(raw) : {};
  } catch (e) {
    return {};
  }
}

function loadPos(ra, survey) {
  const raw = localStorage.getItem(posKey(ra, survey));
  const pos = raw ? parseInt(raw, 10) : 0;
  return isNaN(pos) ? 0 : pos;
}

// ── CSV Import ────────────────────────────
// Parses exported CSVs and merges into localStorage per (ra, survey).
let pendingImports = {};  // { "ra__survey": { varId: {dimension, concept, timestamp} } }

function parseCSVLine(line) {
  const fields = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (inQuotes) {
      if (ch === '"' && line[i + 1] === '"') { current += '"'; i++; }
      else if (ch === '"') { inQuotes = false; }
      else { current += ch; }
    } else {
      if (ch === '"') { inQuotes = true; }
      else if (ch === ',') { fields.push(current.trim()); current = ''; }
      else { current += ch; }
    }
  }
  fields.push(current.trim());
  return fields;
}

function importCSVText(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) return 0;

  // Detect header
  const header = parseCSVLine(lines[0]).map(h => h.toLowerCase().replace(/['"]/g, ''));
  const iRA = header.indexOf('ra_id');
  const iSurvey = header.indexOf('survey_id');
  const iVar = header.indexOf('var_name');
  const iDim = header.indexOf('dimension');
  const iConcept = header.indexOf('concept');
  const iTime = header.indexOf('timestamp');

  if (iSurvey < 0 || iVar < 0 || iDim < 0) return 0;

  let count = 0;
  for (let i = 1; i < lines.length; i++) {
    const f = parseCSVLine(lines[i]);
    const ra = iRA >= 0 ? f[iRA] : '';
    const survey = f[iSurvey];
    const varName = f[iVar];
    const dim = f[iDim];
    const concept = iConcept >= 0 ? f[iConcept] : 'none';
    const ts = iTime >= 0 ? f[iTime] : new Date().toISOString();

    if (!survey || !varName || !dim) continue;

    const key = `${survey}__${varName}`;
    const storeKey = `${ra}__${survey}`;

    if (!pendingImports[storeKey]) pendingImports[storeKey] = {};
    pendingImports[storeKey][key] = { dimension: dim, concept: concept || 'none', timestamp: ts };
    count++;
  }
  return count;
}

function commitImports(ra, survey) {
  // Merge all pending imports that match this (ra, survey) or (any ra, survey) into localStorage
  let merged = loadAnswers(ra, survey);
  let added = 0;
  for (const storeKey in pendingImports) {
    const [importRA, importSurvey] = storeKey.split('__');
    if (importSurvey !== survey) continue;
    const entries = pendingImports[storeKey];
    for (const varId in entries) {
      if (!merged[varId]) added++;
      merged[varId] = entries[varId];
    }
  }
  if (added > 0) {
    localStorage.setItem(storageKey(ra, survey), JSON.stringify(merged));
  }
  return added;
}

function handleCSVUpload(files) {
  pendingImports = {};
  const info = document.getElementById('import-info');
  let totalRows = 0;
  let filesRead = 0;

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      totalRows += importCSVText(e.target.result);
      filesRead++;
      if (filesRead === files.length) {
        if (totalRows > 0) {
          const surveys = new Set();
          for (const k in pendingImports) {
            const s = k.split('__')[1];
            if (s) surveys.add(s);
          }
          info.textContent = `Loaded ${totalRows} records from ${files.length} file(s) across ${surveys.size} survey(s)`;
          info.style.display = 'block';
        } else {
          info.textContent = 'No valid records found in CSV file(s)';
          info.style.display = 'block';
        }
        updateResumeInfo();
      }
    };
    reader.readAsText(file);
  });
}

// ── Screen Management ──────────────────────
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ── Data Loading ───────────────────────────
async function loadData() {
  // Show slow-network hint after 3s
  const hintTimer = setTimeout(() => {
    const hint = document.getElementById('loading-hint');
    if (hint) hint.style.display = 'block';
  }, 3000);

  try {
    const [varsRes, conRes] = await Promise.all([
      fetch('variables.json'),
      fetch('concepts.json')
    ]);
    if (!varsRes.ok || !conRes.ok) throw new Error('Failed to load data files');
    allVariables = await varsRes.json();
    concepts = await conRes.json();
    clearTimeout(hintTimer);
    initSetup();
  } catch (e) {
    clearTimeout(hintTimer);
    document.getElementById('loading-screen').innerHTML =
      `<p style="color:#c0392b; padding:2rem; text-align:center;">
        加载失败：${e.message}<br>
        <small>请检查网络连接后刷新页面重试。<br>
        如果反复失败，请使用 WiFi 或换一个浏览器（推荐 Chrome / Safari）。</small>
      </p>`;
  }
}

// ── Setup Screen ───────────────────────────
function initSetup() {
  // Build survey list
  const surveys = [...new Set(allVariables.map(v => v.survey))].sort();
  const sel = document.getElementById('survey-select');
  surveys.forEach(s => {
    const count = allVariables.filter(v => v.survey === s).length;
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = `${s} (${count} vars)`;
    sel.appendChild(opt);
  });

  // Restore RA name
  const savedRA = localStorage.getItem('coding_ra_name');
  if (savedRA) document.getElementById('ra-name').value = savedRA;

  // Enable/disable start button
  const raInput = document.getElementById('ra-name');
  const check = () => {
    const ok = raInput.value.trim() && sel.value;
    document.getElementById('start-btn').disabled = !ok;
    updateResumeInfo();
  };
  raInput.addEventListener('input', check);
  sel.addEventListener('change', check);
  check();

  document.getElementById('csv-upload').addEventListener('change', function() {
    if (this.files.length > 0) handleCSVUpload(this.files);
  });

  document.getElementById('start-btn').addEventListener('click', startCoding);
  showScreen('setup-screen');

  // Warn if localStorage is unavailable (private browsing, WeChat, etc.)
  if (!storageAvailable) {
    const warn = document.createElement('div');
    warn.style.cssText = 'background:#fff3cd;color:#856404;border:1px solid #ffc107;border-radius:6px;padding:0.6rem 0.8rem;font-size:0.82rem;text-align:center;max-width:360px;line-height:1.5;';
    warn.innerHTML = '<b>注意：</b>当前浏览器不支持本地存储（可能处于无痕/隐私模式，或使用了微信/QQ 内置浏览器）。<br>编码结果<b>无法自动保存</b>，请用 Safari / Chrome 打开此页面，并<b>频繁导出 CSV</b>。';
    document.querySelector('.setup-form').prepend(warn);
  }
}

function updateResumeInfo() {
  const ra = document.getElementById('ra-name').value.trim();
  const survey = document.getElementById('survey-select').value;
  const info = document.getElementById('resume-info');
  if (!ra || !survey) { info.style.display = 'none'; return; }

  // Count from localStorage + pending imports
  const saved = loadAnswers(ra, survey);
  let count = Object.keys(saved).length;
  for (const storeKey in pendingImports) {
    const importSurvey = storeKey.split('__')[1];
    if (importSurvey === survey) {
      for (const varId in pendingImports[storeKey]) {
        if (!saved[varId]) count++;
      }
    }
  }
  if (count > 0) {
    const pos = loadPos(ra, survey);
    info.textContent = `Resuming: ${count} already coded` + (pos > 0 ? `, position ${pos + 1}` : '');
    info.style.display = 'block';
  } else {
    info.style.display = 'none';
  }
}

// ── Start Coding ───────────────────────────
function startCoding() {
  raName = document.getElementById('ra-name').value.trim();
  currentSurvey = document.getElementById('survey-select').value;
  localStorage.setItem('coding_ra_name', raName);

  // Merge any uploaded CSV data into localStorage first
  const imported = commitImports(raName, currentSurvey);

  surveyVars = allVariables.filter(v => v.survey === currentSurvey);
  if (surveyVars.length === 0) {
    alert(`Survey "${currentSurvey}" has no variables.`);
    return;
  }
  answers = loadAnswers(raName, currentSurvey);
  currentIdx = loadPos(raName, currentSurvey);

  // Clamp index
  if (currentIdx >= surveyVars.length) currentIdx = surveyVars.length - 1;
  if (currentIdx < 0) currentIdx = 0;

  buildDimButtons();
  showScreen('coding-screen');
  renderVariable();
  _sessionId = '';  // reset for new session
  beacon('session_start', { cc: Object.keys(answers).length, tv: surveyVars.length });
}

// ── Dimension Buttons ──────────────────────
function buildDimButtons() {
  const grid = document.getElementById('dim-grid');
  // Preserve tooltip element
  const tooltip = document.getElementById('dim-tooltip');
  grid.innerHTML = '';
  grid.appendChild(tooltip);

  concepts.dimensions.forEach(dim => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-dim';
    btn.dataset.dim = dim.id;
    btn.textContent = DIM_SHORT[dim.id] || dim.id;
    btn.style.setProperty('--bg', DIM_COLORS[dim.id] || '#666');
    btn.addEventListener('click', () => selectDimension(dim.id));
    attachTooltip(btn, dim.id);
    grid.appendChild(btn);
  });

  // "Not relevant" button
  const noneBtn = document.createElement('button');
  noneBtn.className = 'btn btn-none';
  noneBtn.dataset.dim = 'none';
  noneBtn.textContent = 'Not Relevant';
  noneBtn.addEventListener('click', () => selectNone());
  attachTooltip(noneBtn, 'none');
  grid.appendChild(noneBtn);
}

// ── Tooltip Logic ───────────────────────
let tooltipTimer = null;
function attachTooltip(btn, dimId) {
  const info = DIM_TOOLTIPS[dimId];
  if (!info) return;

  btn.addEventListener('mouseenter', () => {
    tooltipTimer = setTimeout(() => showDimTooltip(btn, info), 400);
  });
  btn.addEventListener('mouseleave', () => {
    clearTimeout(tooltipTimer);
    hideDimTooltip();
  });
  // Long-press for mobile
  let touchTimer = null;
  btn.addEventListener('touchstart', (e) => {
    touchTimer = setTimeout(() => {
      showDimTooltip(btn, info);
    }, 500);
  }, { passive: true });
  btn.addEventListener('touchend', () => { clearTimeout(touchTimer); });
  btn.addEventListener('touchmove', () => { clearTimeout(touchTimer); });
}

function showDimTooltip(btn, info) {
  const tooltip = document.getElementById('dim-tooltip');
  tooltip.innerHTML = `
    <div class="tt-title">${escHtml(info.title)}</div>
    <div class="tt-body">${escHtml(info.body)}</div>
    <div class="tt-examples">${escHtml(info.examples)}</div>
    <div class="tt-note">${escHtml(DIM_TOOLTIP_NOTE)}</div>`;
  // Position below the button
  const grid = document.getElementById('dim-grid');
  const gridRect = grid.getBoundingClientRect();
  const btnRect = btn.getBoundingClientRect();
  tooltip.style.top = (btnRect.bottom - gridRect.top + 6) + 'px';
  tooltip.classList.add('visible');
}

function hideDimTooltip() {
  document.getElementById('dim-tooltip').classList.remove('visible');
}

// Dismiss tooltip on tap elsewhere (mobile)
document.addEventListener('touchstart', function(e) {
  const tooltip = document.getElementById('dim-tooltip');
  if (tooltip.classList.contains('visible') && !tooltip.contains(e.target)) {
    hideDimTooltip();
  }
}, { passive: true });

// ── Render Variable ────────────────────────
function renderVariable() {
  if (!surveyVars.length) return;
  _varRenderTime = performance.now();
  const v = _retestMode ? _retestVar : surveyVars[currentIdx];

  // Top bar
  document.getElementById('tb-survey').textContent = currentSurvey;
  const coded = Object.keys(answers).length;
  document.getElementById('tb-progress').textContent =
    `${currentIdx + 1}/${surveyVars.length} · ${coded} coded`;

  // Progress bar
  const pct = surveyVars.length > 0 ? (coded / surveyVars.length) * 100 : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-text').textContent =
    `${coded} / ${surveyVars.length} coded (${Math.round(pct)}%)`;

  // Variable card
  document.getElementById('var-name').textContent = v.var;
  document.getElementById('var-lang').textContent = v.lang || '';
  document.getElementById('var-label').textContent = v.label || '(no label)';

  const valList = document.getElementById('val-list');
  valList.innerHTML = '';
  if (v.values && typeof v.values === 'object') {
    // Sort keys numerically
    const keys = Object.keys(v.values).sort((a, b) => {
      const na = parseFloat(a), nb = parseFloat(b);
      if (!isNaN(na) && !isNaN(nb)) return na - nb;
      return a.localeCompare(b);
    });
    keys.forEach(k => {
      const li = document.createElement('li');
      li.className = 'val-item';
      li.innerHTML = `<span class="val-code">${escHtml(k)}</span>
                      <span class="val-label">= ${escHtml(v.values[k])}</span>`;
      valList.appendChild(li);
    });
  }

  // Check if already coded (hide in retest mode for unbiased re-coding)
  const existing = _retestMode ? null : answers[v.id];
  const indicator = document.getElementById('coded-indicator');
  if (existing) {
    const dimLabel = existing.dimension === 'none' ? 'Not Relevant'
      : (DIM_SHORT[existing.dimension] || existing.dimension);
    const conLabel = existing.concept && existing.concept !== 'none'
      ? ` → ${existing.concept}` : '';
    indicator.innerHTML = `<span class="coded-badge">Previously coded: ${escHtml(dimLabel)}${escHtml(conLabel)}</span>`;
    indicator.style.display = 'block';
  } else {
    indicator.style.display = 'none';
  }

  // Reset selection state
  resetSelection();

  // If already coded, pre-select
  if (existing) {
    if (existing.dimension === 'none') {
      selectNone(true);
    } else {
      selectDimension(existing.dimension, true);
      if (existing.concept) {
        selectedConcept = existing.concept;
        highlightConcept();
        document.getElementById('btn-confirm').disabled = false;
      }
    }
  }

  // Back button state
  document.getElementById('btn-prev').disabled = currentIdx === 0;

  // Update inline stats & clock
  updateInlineStats();
  updateGreetings();
}

function resetSelection() {
  selectedDim = null;
  selectedConcept = null;
  document.querySelectorAll('.btn-dim').forEach(b => {
    b.classList.remove('selected');
    b.style.background = '';
    b.style.color = '';
    b.style.borderColor = '';
  });
  document.querySelectorAll('.btn-none').forEach(b => {
    b.classList.remove('selected');
  });
  document.getElementById('concept-panel').classList.remove('visible');
  document.getElementById('concept-search').value = '';
  document.getElementById('btn-confirm').disabled = true;
}

// ── Dimension Selection ────────────────────
function selectDimension(dimId, silent) {
  resetSelection();
  hideDimTooltip();
  selectedDim = dimId;

  // Highlight button
  document.querySelectorAll('.btn-dim').forEach(b => {
    if (b.dataset.dim === dimId) {
      b.classList.add('selected');
      b.style.background = DIM_COLORS[dimId] || '#666';
      b.style.color = '#fff';
      b.style.borderColor = 'transparent';
    }
  });

  // Show concept list
  const dim = concepts.dimensions.find(d => d.id === dimId);
  if (dim) {
    renderConceptList(dim.concepts);
    document.getElementById('concept-panel').classList.add('visible');
  }

  // Confirm not yet enabled until concept chosen
  document.getElementById('btn-confirm').disabled = true;
}

function selectNone(silent) {
  resetSelection();
  hideDimTooltip();
  selectedDim = 'none';
  selectedConcept = 'none';
  document.querySelectorAll('.btn-none').forEach(b => {
    b.classList.add('selected');
  });
  document.getElementById('btn-confirm').disabled = false;
}

// ── Concept List ───────────────────────────
function renderConceptList(conceptArr, filter) {
  const list = document.getElementById('concept-list');
  list.innerHTML = '';
  const q = (filter || '').toLowerCase().trim();

  conceptArr.forEach(c => {
    // Safety: label may be array (take first) or string
    const label = Array.isArray(c.label) ? (c.label[0] || '') : (c.label || '');
    const matchId = c.id.toLowerCase().includes(q);
    const matchLabel = label.toLowerCase().includes(q);
    if (q && !matchId && !matchLabel) return;

    const div = document.createElement('div');
    div.className = 'concept-item' + (selectedConcept === c.id ? ' selected' : '');
    div.innerHTML = `
      <div class="concept-radio"></div>
      <div>
        <div class="concept-id">${escHtml(c.id)}</div>
        <div class="concept-anchor">${escHtml(label)}</div>
      </div>`;
    div.addEventListener('click', () => {
      selectedConcept = c.id;
      highlightConcept();
      document.getElementById('btn-confirm').disabled = false;
    });
    list.appendChild(div);
  });
}

function highlightConcept() {
  document.querySelectorAll('.concept-item').forEach(el => {
    const id = el.querySelector('.concept-id').textContent;
    el.classList.toggle('selected', id === selectedConcept);
  });
}

// ── Concept Search ─────────────────────────
document.getElementById('concept-search').addEventListener('input', function() {
  if (!selectedDim || selectedDim === 'none') return;
  const dim = concepts.dimensions.find(d => d.id === selectedDim);
  if (dim) renderConceptList(dim.concepts, this.value);
});

// ── Confirm ────────────────────────────────
document.getElementById('btn-confirm').addEventListener('click', () => {
  if (!selectedDim) return;

  // ── Test-Retest: handle retest confirm ──
  if (_retestMode) {
    beacon('confirm', {
      vi: _retestVar.id, dm: selectedDim, cn: selectedConcept || 'none',
      vm: viewDuration(), cc: Object.keys(answers).length, tv: surveyVars.length,
      rt: '1', oa: _retestOriginal.dimension
    });
    _retestMode = false;
    _retestVar = null;
    _retestOriginal = null;
    renderVariable();
    window.scrollTo(0, 0);
    return;
  }

  const v = surveyVars[currentIdx];
  answers[v.id] = {
    dimension: selectedDim,
    concept: selectedConcept || 'none',
    timestamp: new Date().toISOString()
  };
  saveAnswers();
  beacon('confirm', {
    vi: v.id, dm: selectedDim, cn: selectedConcept || 'none',
    vm: viewDuration(), cc: Object.keys(answers).length, tv: surveyVars.length
  });

  const coded = Object.keys(answers).length;
  checkMilestone(coded);
  checkSaveReminder(coded);
  updateInlineStats();

  // ── Test-Retest: maybe trigger a retest before advancing ──
  if (coded >= RETEST_MIN_CODED && Math.random() < RETEST_PROB) {
    const codedIds = Object.keys(answers);
    const pickId = codedIds[Math.floor(Math.random() * codedIds.length)];
    const pickVar = surveyVars.find(sv => sv.id === pickId);
    if (pickVar) {
      _retestMode = true;
      _retestVar = pickVar;
      _retestOriginal = { dimension: answers[pickId].dimension, concept: answers[pickId].concept };
      renderVariable();
      window.scrollTo(0, 0);
      return;
    }
  }

  // Advance
  if (currentIdx < surveyVars.length - 1) {
    currentIdx++;
    saveAnswers();
    renderVariable();
    window.scrollTo(0, 0);
  } else {
    // All done
    renderVariable();
    alert(`${currentSurvey} 的全部 ${surveyVars.length} 个变量已完成编码！\n\n请立刻点击 Export 按钮下载 CSV 保存结果，避免工作量损失。`);
  }
});

// ── Skip ───────────────────────────────────
document.getElementById('btn-skip').addEventListener('click', () => {
  if (_retestMode) { _retestMode = false; _retestVar = null; _retestOriginal = null; renderVariable(); window.scrollTo(0, 0); return; }
  if (currentIdx < surveyVars.length - 1) {
    currentIdx++;
    saveAnswers();
    renderVariable();
    window.scrollTo(0, 0);
  }
});

// ── Back ───────────────────────────────────
document.getElementById('btn-prev').addEventListener('click', () => {
  if (_retestMode) { _retestMode = false; _retestVar = null; _retestOriginal = null; renderVariable(); window.scrollTo(0, 0); return; }
  if (currentIdx > 0) {
    currentIdx--;
    saveAnswers();
    renderVariable();
    window.scrollTo(0, 0);
  }
});

// ── Stats ──────────────────────────────────
document.getElementById('btn-back-coding').addEventListener('click', () => {
  showScreen('coding-screen');
});

function showStats() {
  const total = surveyVars.length;
  const coded = Object.keys(answers).length;
  const pct = total > 0 ? Math.round((coded / total) * 100) : 0;

  // Count by dimension
  const dimCounts = {};
  concepts.dimensions.forEach(d => { dimCounts[d.id] = 0; });
  dimCounts['none'] = 0;
  Object.values(answers).forEach(a => {
    if (dimCounts[a.dimension] !== undefined) dimCounts[a.dimension]++;
    else dimCounts[a.dimension] = 1;
  });

  const grid = document.getElementById('stats-grid');
  grid.innerHTML = `
    <div class="stat-card">
      <div class="stat-number">${coded}</div>
      <div class="stat-label">Coded</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${total - coded}</div>
      <div class="stat-label">Remaining</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${pct}%</div>
      <div class="stat-label">Complete</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${currentIdx + 1}</div>
      <div class="stat-label">Current Position</div>
    </div>`;

  const dimDiv = document.getElementById('dim-stats');
  dimDiv.innerHTML = '<h3 class="serif" style="margin-bottom:0.5rem; font-size:1.1rem;">By Dimension</h3>';
  concepts.dimensions.forEach(d => {
    dimDiv.innerHTML += `<div class="dim-stat-row">
      <span class="dim-stat-label" style="color:${DIM_COLORS[d.id] || '#666'}">${d.label}</span>
      <span class="dim-stat-count">${dimCounts[d.id] || 0}</span>
    </div>`;
  });
  dimDiv.innerHTML += `<div class="dim-stat-row">
    <span class="dim-stat-label" style="color:var(--dim-none)">Not Relevant</span>
    <span class="dim-stat-count">${dimCounts['none'] || 0}</span>
  </div>`;

  showScreen('stats-screen');
}

// ── Export CSV ──────────────────────────────
document.getElementById('btn-export').addEventListener('click', exportCSV);

function exportCSV() {
  const rows = [['ra_id', 'survey_id', 'var_name', 'dimension', 'concept', 'timestamp']];

  surveyVars.forEach(v => {
    const a = answers[v.id];
    if (a) {
      rows.push([
        raName,
        v.survey,
        v.var,
        a.dimension,
        a.concept,
        a.timestamp
      ]);
    }
  });

  if (rows.length <= 1) {
    alert('还没有编码结果可以导出。');
    return;
  }

  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `coding_${raName}_${currentSurvey}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);

  // Track export state (disarms beforeunload warning)
  lastExportedCount = Object.keys(answers).length;
  beacon('export', { cc: lastExportedCount });
}

// ── Switch Survey ──────────────────────────
document.getElementById('btn-change-survey').addEventListener('click', () => {
  const coded = Object.keys(answers).length;
  if (coded > 0 && coded > lastExportedCount) {
    if (!confirm(`你有 ${coded - lastExportedCount} 条未导出的编码结果。\n\n切换前建议先导出 CSV 保存。确定要切换吗？`)) return;
  }
  showScreen('setup-screen');
});

// ── Utilities ──────────────────────────────
function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ── Solar Terms (24 节气) ────────────────
function getSolarTerm(date) {
  const terms = [
    { name: '小寒', m: 1, d: 5 },  { name: '大寒', m: 1, d: 20 },
    { name: '立春', m: 2, d: 4 },  { name: '雨水', m: 2, d: 19 },
    { name: '惊蛰', m: 3, d: 5 },  { name: '春分', m: 3, d: 20 },
    { name: '清明', m: 4, d: 4 },  { name: '谷雨', m: 4, d: 20 },
    { name: '立夏', m: 5, d: 5 },  { name: '小满', m: 5, d: 21 },
    { name: '芒种', m: 6, d: 5 },  { name: '夏至', m: 6, d: 21 },
    { name: '小暑', m: 7, d: 7 },  { name: '大暑', m: 7, d: 22 },
    { name: '立秋', m: 8, d: 7 },  { name: '处暑', m: 8, d: 23 },
    { name: '白露', m: 9, d: 7 },  { name: '秋分', m: 9, d: 23 },
    { name: '寒露', m: 10, d: 8 }, { name: '霜降', m: 10, d: 23 },
    { name: '立冬', m: 11, d: 7 }, { name: '小雪', m: 11, d: 22 },
    { name: '大雪', m: 12, d: 7 }, { name: '冬至', m: 12, d: 22 },
  ];
  const mo = date.getMonth() + 1, dy = date.getDate();
  let cur = terms[terms.length - 1];
  for (let i = terms.length - 1; i >= 0; i--) {
    if (mo > terms[i].m || (mo === terms[i].m && dy >= terms[i].d)) {
      cur = terms[i]; break;
    }
  }
  return cur.name;
}

function getGreeting(hour) {
  if (hour >= 23 || hour < 5)  return '夜深了，注意休息';
  if (hour < 9)  return '早上好';
  if (hour < 11) return '上午好';
  if (hour < 13) return '中午好，记得吃饭';
  if (hour < 14) return '午后时光，稍事休息';
  if (hour < 17) return '下午好';
  if (hour < 19) return '傍晚了，辛苦啦';
  return '晚上好，早点休息';
}

function formatDateCN(date) {
  const y = date.getFullYear();
  const m = date.getMonth() + 1;
  const d = date.getDate();
  const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
  return `${y}年${m}月${d}日 星期${weekdays[date.getDay()]}`;
}

function updateGreetings() {
  const now = new Date();
  const hour = now.getHours();

  // Setup screen greeting
  const dateEl = document.getElementById('greeting-date');
  const termEl = document.getElementById('greeting-term');
  const msgEl = document.getElementById('greeting-msg');
  if (dateEl) dateEl.textContent = formatDateCN(now);
  if (termEl) termEl.textContent = getSolarTerm(now);
  if (msgEl) msgEl.textContent = getGreeting(hour);

  // Topbar time
  const timeEl = document.getElementById('topbar-time');
  if (timeEl) {
    const hh = String(hour).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    timeEl.textContent = `${hh}:${mm}`;
  }

  // Coding view caring message
  const codingGreet = document.getElementById('coding-greeting');
  if (codingGreet) codingGreet.textContent = getGreeting(hour);
}

// ── Inline Stats ──────────────────────────
function updateInlineStats() {
  const el = document.getElementById('inline-stats');
  if (!el || !concepts) return;
  const dimCounts = {};
  concepts.dimensions.forEach(d => { dimCounts[d.id] = 0; });
  dimCounts['none'] = 0;
  Object.values(answers).forEach(a => {
    if (dimCounts[a.dimension] !== undefined) dimCounts[a.dimension]++;
    else dimCounts[a.dimension] = 1;
  });
  const parts = concepts.dimensions.map(d => {
    const short = DIM_SHORT[d.id] || d.id;
    const color = DIM_COLORS[d.id] || '#666';
    return `<span style="color:${color}">${short}</span>&nbsp;${dimCounts[d.id]}`;
  });
  parts.push(`<span style="color:var(--dim-none)">N/A</span>&nbsp;${dimCounts['none']}`);
  el.innerHTML = parts.join(' &middot; ');
}

// ── Milestone Celebration ─────────────────
const MILESTONE_MESSAGES = [
  { n: 10, msg: '好的开始！', sub: '已经编码了 10 个变量' },
  { n: 25, msg: '加油！', sub: '已完成 25 个' },
  { n: 50, msg: '太棒了！', sub: '半百大关！' },
  { n: 100, msg: '了不起！', sub: '三位数了！' },
  { n: 150, msg: '厉害！', sub: '150 个变量' },
  { n: 200, msg: '惊人的毅力！', sub: '200 个！' },
  { n: 250, msg: '超级厉害！', sub: '250 个变量' },
  { n: 300, msg: '即将完成！', sub: '300 个！冲刺！' },
  { n: 500, msg: '不可思议！', sub: '500 个变量！' },
  { n: 750, msg: '传奇！', sub: '750 个！' },
  { n: 1000, msg: '千变量大师！', sub: '这是一个里程碑！' },
];

function checkMilestone(count) {
  const ms = MILESTONE_MESSAGES.find(m => m.n === count);
  if (!ms) return;
  const toast = document.getElementById('milestone-toast');
  document.getElementById('toast-number').textContent = ms.n;
  document.getElementById('toast-msg').textContent = ms.msg;
  document.getElementById('toast-sub').textContent = ms.sub;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2200);
}

// ── Save Reminder ─────────────────────────
let lastRemindCount = 0;
function checkSaveReminder(count) {
  // First reminder at 5, then every 20 — undergrads need frequent nudges
  const sinceExport = count - lastExportedCount;
  const shouldRemind = (count === 5 && lastExportedCount === 0)
    || (sinceExport > 0 && sinceExport % 20 === 0);
  if (shouldRemind && count !== lastRemindCount) {
    lastRemindCount = count;
    const el = document.getElementById('save-reminder');
    if (!el) return;
    el.className = 'save-reminder';
    const unexported = sinceExport;
    el.textContent = `你有 ${unexported} 条未导出的编码结果，建议点击 Export 保存 CSV`;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 6000);
  }
}

// ── Keyboard Shortcuts ────────────────────
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
  if (!document.getElementById('coding-screen').classList.contains('active')) return;

  const key = e.key;

  // 1-6: select dimension
  if (key >= '1' && key <= '6') {
    const dims = concepts.dimensions;
    const idx = parseInt(key) - 1;
    if (idx < dims.length) { selectDimension(dims[idx].id); e.preventDefault(); }
    return;
  }
  // N or 0: not relevant
  if (key === 'n' || key === 'N' || key === '0') { selectNone(); e.preventDefault(); return; }
  // Enter: confirm
  if (key === 'Enter') {
    const btn = document.getElementById('btn-confirm');
    if (!btn.disabled) { btn.click(); e.preventDefault(); }
    return;
  }
  // ArrowLeft: previous
  if (key === 'ArrowLeft' || key === '[') { document.getElementById('btn-prev').click(); e.preventDefault(); return; }
  // ArrowRight: skip/next
  if (key === 'ArrowRight' || key === ']') { document.getElementById('btn-skip').click(); e.preventDefault(); return; }
});

// ── Clock Interval ────────────────────────
setInterval(updateGreetings, 60000);

// ── localStorage Availability Test ────────
function testLocalStorage() {
  try {
    const k = '__ls_test__';
    localStorage.setItem(k, '1');
    localStorage.removeItem(k);
    return true;
  } catch (e) {
    return false;
  }
}

// ── beforeunload: warn if unexported work ─
window.addEventListener('beforeunload', function(e) {
  const coded = Object.keys(answers).length;
  if (coded > 0 && coded > lastExportedCount) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// ── visibilitychange: save when backgrounded
document.addEventListener('visibilitychange', function() {
  if (document.hidden && raName && currentSurvey) {
    saveAnswers();
    beacon('session_end', { cc: Object.keys(answers).length });
  }
});

// ── Boot ───────────────────────────────────
storageAvailable = testLocalStorage();
updateGreetings();
loadData();
</script>
</body>
</html>
